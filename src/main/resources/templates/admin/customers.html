<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	th:replace="~{admin/base :: layout(~{::#admin-content-wrapper}, ~{::script}, 'customers')}">
<head>
<title>Manage Customers - MK Admin Portal</title>
</head>
<body>

	<div id="admin-content-wrapper"
		th:attr="data-show-add-customer-modal=${#fields.hasErrors('customerCreateDto.*') ? 'true' : 'false'},
                 data-show-edit-customer-modal=${#fields.hasErrors('customerUpdateDto.*') ? 'true' : 'false'}">
		<div
			class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
			<h1 class="mb-3 mb-md-0 section-title">Customer Management</h1>
			<div class="d-flex gap-2">
				<button sec:authorize="hasAuthority('ADD_CUSTOMERS')"
					class="btn btn-action-add" type="button" data-bs-toggle="modal"
					data-bs-target="#addCustomerModal">
					<i class="fa-solid fa-plus me-1"></i> Add Customer
				</button>
			</div>
		</div>

		<div th:replace="~{admin/fragments/common-alerts :: userAlerts}"></div>

		<div class="row text-center mb-4">
			<div class="col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Total Customers</h5>
						<p class="display-6 fw-bold" th:text="${totalItems}">0</p>
					</div>
				</div>
			</div>
			<div class="col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Active Customers</h5>
						<p class="display-6 fw-bold text-success"
							th:text="${activeCustomerCount}">?</p>
					</div>
				</div>
			</div>
			<div class="col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Inactive Customers</h5>
						<p class="display-6 fw-bold text-danger"
							th:text="${inactiveCustomerCount}">?</p>
					</div>
				</div>
			</div>
		</div>
		<form th:action="@{/admin/customers}" method="get"
			class="mb-4 p-3 bg-light rounded shadow-sm">
			<div class="d-flex flex-column flex-md-row gap-2">
				<div class="flex-grow-1">
					<label for="keyword" class="form-label">Search by Name,
						Username, Phone</label> <input type="text" class="form-control"
						id="keyword" name="keyword" th:value="${keyword}"
						placeholder="Enter search term...">
				</div>
				<div class="d-flex gap-2 align-self-md-end" style="flex-shrink: 0;">
					<button type="submit" class="btn btn-action-view" title="Search">
						<i class="fa-solid fa-search"></i> <span
							class="d-none d-md-inline ms-1">Search</span>
					</button>
					<a th:href="@{/admin/customers}" class="btn btn-custom-secondary"
						title="Clear Filters"> <i class="fa-solid fa-times"></i> <span
						class="d-none d-md-inline ms-1">Clear</span>
					</a>
				</div>
			</div>
		</form>

		<div class="card">
			<div class="card-header">
				<h5 class="mb-0">Customers List</h5>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover align-middle text-center">
						<thead class="table-light">
							<tr>
								<th>ID</th>
								<th>Name</th>
								<th>Username</th>
								<th>Email</th>
								<th>Phone</th>
								<th>Address</th>
								<th>Status</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="customer : ${customers}"
								th:data-name="${customer.firstName + ' ' + customer.lastName}"
								th:data-username="${customer.username}"
								th:data-email="${customer.email != null ? customer.email : 'N/A'}"
								th:data-phone="${customer.phone != null ? customer.phone : 'N/A'}"
								th:data-address-line1="${(customer.houseNo != null ? customer.houseNo : '') + ' ' + (customer.street != null ? customer.street : '')}"
								th:data-address-line2="${(customer.barangay != null ? customer.barangay : '') + ', ' + (customer.municipality != null ? customer.municipality : '') + ', ' + (customer.province != null ? customer.province : '')}"
								th:data-created-at="${customer.createdAt != null ? #temporals.format(customer.createdAt, 'MMM dd, yyyy HH:mm') : 'N/A'}"
								th:data-last-activity="${customer.lastActivity != null ? #temporals.format(customer.lastActivity, 'MMM dd, yyyy HH:mm') : 'N/A'}"
								th:data-status="${customer.status}">

								<td th:text="${customer.id}">001</td>
								<td th:text="${customer.firstName + ' ' + customer.lastName}">Juan
									Dela Cruz</td>
								<td th:text="${customer.username}">Juan_Dela</td>
								<td th:text="${customer.email != null ? customer.email : 'N/A'}">N/A</td>
								<td th:text="${customer.phone != null ? customer.phone : 'N/A'}">N/A</td>
								<td
									th:text="${customer.street != null ? (customer.street + ', ' + customer.barangay) : 'N/A'}">N/A</td>
								<td><span class="status-badge"
									th:text="${customer.status != null ? customer.status : 'N/A'}"
									th:classappend="${customer.status == 'ACTIVE' ? 'status-active' : 'status-cancelled'}">Status</span>
								</td>
								<td class="d-flex justify-content-center gap-2">
									<button class="btn btn-sm btn-action-view"
										data-bs-toggle="modal" data-bs-target="#viewCustomerModal">View</button>

									<button type="button"
										sec:authorize="hasAuthority('EDIT_CUSTOMERS')"
										class="btn btn-sm btn-action-edit edit-customer-btn"
										data-bs-toggle="modal" data-bs-target="#editCustomerModal"
										th:data-id="${customer.id}"
										th:data-first-name="${customer.firstName}"
										th:data-last-name="${customer.lastName}"
										th:data-username="${customer.username}"
										th:data-email="${customer.email}"
										th:data-phone="${customer.phone}"
										th:data-house-no="${customer.houseNo}"
										th:data-lot-no="${customer.lotNo}"
										th:data-block-no="${customer.blockNo}"
										th:data-street="${customer.street}"
										th:data-barangay="${customer.barangay}"
										th:data-municipality="${customer.municipality}"
										th:data-province="${customer.province}"
										th:data-status="${customer.status}">Edit</button>

									<form sec:authorize="hasAuthority('DELETE_CUSTOMERS')"
										th:action="@{/admin/customers/delete/{id}(id=${customer.id})}"
										method="post"
										th:data-confirm-message="'Are you sure you want to delete the customer \'' + ${customer.username} + '\'?'">
										<button type="submit" class="btn btn-sm btn-action-delete">Delete</button>
									</form>
								</td>
							</tr>
							<tr th:if="${#lists.isEmpty(customers)}">
								<td colspan="8" class="text-center text-muted"
									th:text="${keyword != null ? 'No customers found matching your search.' : 'No customers found.'}">
									No customers found.</td>
							</tr>
						</tbody>
					</table>
				</div>

				<div th:if="${customerPage.totalPages > 0}"
					class="d-flex justify-content-between align-items-center mt-3">

					<span class="text-muted small"
						th:text="'Showing ' + ${customerPage.number * customerPage.size + 1} + 
                               ' - ' + ${customerPage.number * customerPage.size + customerPage.numberOfElements} + 
                               ' of ' + ${customerPage.totalElements}">
					</span>

					<nav aria-label="User Pagination">
						<ul class="pagination pagination-sm mb-0">

							<li class="page-item"
								th:classappend="${customerPage.first} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/customers(page=${customerPage.number - 1}, size=${size}, keyword=${keyword})}">Previous</a>
							</li>

							<th:block
								th:each="i : ${#numbers.sequence(0, customerPage.totalPages - 1)}"
								th:if="${customerPage.totalPages <= 7 || i == 0 || i == customerPage.totalPages - 1 || (i >= customerPage.number - 2 && i <= customerPage.number + 2)}">

								<li class="page-item disabled"
									th:if="${customerPage.totalPages > 7 && (i == 0 && customerPage.number > 3 || i == customerPage.totalPages - 1 && customerPage.number < customerPage.totalPages - 4)}">
									<span class="page-link">...</span>
								</li>

								<li class="page-item"
									th:classappend="${i == customerPage.number} ? 'active'"><a
									class="page-link"
									th:href="@{/admin/customers(page=${i}, size=${size}, keyword=${keyword})}"
									th:text="${i + 1}"></a></li>
							</th:block>

							<li class="page-item"
								th:classappend="${customerPage.last} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/customers(page=${customerPage.number + 1}, size=${size}, keyword=${keyword})}">Next</a>
							</li>
						</ul>
					</nav>

					<span class="text-muted small" style="visibility: hidden;"
						th:text="'Showing ' + ${customerPage.number * customerPage.size + 1} + 
                               ' - ' + ${customerPage.number * customerPage.size + customerPage.numberOfElements} + 
                               ' of ' + ${customerPage.totalElements}">
					</span>
				</div>
			</div>
		</div>

		<div
			th:replace="~{admin/fragments/customer-modals :: all-customer-modals}"></div>

	</div>
	<th:block th:fragment="script">
		<script th:src="@{/js/admin-customers.js}"></script>
	</th:block>

</body>
</html>