<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{admin/base :: layout(~{::main})}">
<head>
<title
	th:text="${productDto.name != null ? productDto.name : 'Edit Product'} + ' - MK Admin'">Edit
	Product - MK Admin</title>
</head>
<body>
	<main class="container mt-4">

		<div class="row justify-content-center">
			<div class="col-lg-8">
				<div class="card shadow-sm">
					<div
						class="card-header d-flex justify-content-between align-items-center">
						<h3 class="mb-0"
							th:text="${'Edit ' + (productDto.name != null ? productDto.name : 'Product')}">Edit
							Product</h3>
						<a th:href="@{/admin/products}" class="btn btn-sm btn-secondary">
							<i class="fa-solid fa-arrow-left me-1"></i> Back to Products
						</a>
					</div>
					<div class="card-body">
						<div th:if="${productError}"
							class="alert alert-danger alert-dismissible fade show"
							role="alert">
							<i class="fa-solid fa-triangle-exclamation me-2"></i> <span
								th:text="${productError}"></span>
							<button type="button" class="btn-close" data-bs-dismiss="alert"
								aria-label="Close"></button>
						</div>
						<div
							th:if="${bindingResult != null and bindingResult.hasErrors()}"
							class="alert alert-danger" role="alert">Please correct the
							errors below.</div>

						<form th:action="@{/admin/products/update}" method="post"
							th:object="${productDto}" id="editProductForm">

							<input type="hidden" th:field="*{id}" />

							<div class="mb-3">
								<label for="editProductName" class="form-label">Product
									Name</label> <input type="text" class="form-control" th:field="*{name}"
									id="editProductName" th:errorclass="is-invalid">
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
							</div>
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="editProductCategory" class="form-label">Category</label>
									<select class="form-select" th:field="*{categoryId}"
										id="editProductCategory" th:errorclass="is-invalid">
										<option value="">-- Select a Category --</option>
										<option th:each="cat : ${categories}" th:value="${cat.id}"
											th:text="${cat.name}"
											th:selected="${cat.id == productDto.categoryId}"></option>
									</select>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('categoryId')}"
										th:errors="*{categoryId}"></div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="editProductPrice" class="form-label">Price</label>
									<div class="input-group"
										th:classappend="${#fields.hasErrors('price')} ? 'is-invalid' : ''">
										<span class="input-group-text">â‚±</span> <input type="number"
											step="0.01" min="0" class="form-control" th:field="*{price}"
											id="editProductPrice" th:errorclass="is-invalid">
									</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
								</div>
							</div>
							<div class="mb-3">
								<label for="editProductDescription" class="form-label">Description
									(Optional)</label>
								<textarea class="form-control" th:field="*{description}"
									id="editProductDescription" rows="2" th:errorclass="is-invalid"></textarea>
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('description')}"
									th:errors="*{description}"></div>
							</div>
							<div class="mb-3">
								<label for="editProductImageUrl" class="form-label">Image
									URL (Optional)</label> <input type="text" class="form-control"
									th:field="*{imageUrl}" id="editProductImageUrl"
									placeholder="e.g., /img/my-product.jpg or https://...">
							</div>


							<hr class="my-4">
							<h5 class="mb-3">Stock Management</h5>
							<div class="row">
								<div class="col-md-4 mb-3">
									<label for="currentStockDisplay" class="form-label">Current
										Stock</label> <input type="number" class="form-control"
										id="currentStockDisplay" name="currentStockDisplay"
										th:value="${product != null ? product.currentStock : 0}"
										readonly disabled>
									<div class="form-text">Adjust stock via "Manage Stock".</div>
								</div>
								<div class="col-md-4 mb-3">
									<label for="editLowThreshold" class="form-label">Low
										Stock Threshold</label> <input type="number" step="1" min="0"
										class="form-control" th:field="*{lowStockThreshold}"
										id="editLowThreshold" th:errorclass="is-invalid">
									<div class="form-text">Status: Low at/below this level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('lowStockThreshold')}"
										th:errors="*{lowStockThreshold}"></div>
								</div>
								<div class="col-md-4 mb-3">
									<label for="editCriticalThreshold" class="form-label">Critical
										Stock Threshold</label> <input type="number" step="1" min="0"
										class="form-control" th:field="*{criticalStockThreshold}"
										id="editCriticalThreshold" th:errorclass="is-invalid">
									<div class="form-text">Status: Critical at/below this
										level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('criticalStockThreshold')}"
										th:errors="*{criticalStockThreshold}"></div>
									<div class="invalid-feedback d-block"
										th:if="${#fields.hasGlobalErrors()}" th:errors="*{global}"></div>
								</div>
							</div>


							<hr class="my-4">
							<h5 class="mb-3">Recipe Ingredients</h5>
							<div id="editIngredientsContainer">
								<div th:each="ingredient, iterStat : *{ingredients}"
									class="row ingredient-row mb-2 gx-2 align-items-center">
									<div class="col-md-6">
										<label class="visually-hidden"
											th:for="|ing-item-${iterStat.index}|">Ingredient</label> <select
											class="form-select form-select-sm ingredient-item"
											th:id="|ing-item-${iterStat.index}|"
											th:name="|ingredients[${iterStat.index}].inventoryItemId|"
											required>
											<option value="">-- Select Ingredient --</option>
											<option th:each="invItem : ${inventoryItems}"
												th:value="${invItem.id}"
												th:text="${invItem.name + ' (' + invItem.unit.abbreviation + ')'}"
												th:selected="${invItem.id == ingredient.inventoryItemId}"></option>
										</select>
									</div>
									<div class="col-md-4">
										<label class="visually-hidden"
											th:for="|ing-qty-${iterStat.index}|">Quantity</label> <input
											type="number" step="0.01" min="0.01"
											class="form-control form-control-sm ingredient-quantity"
											th:id="|ing-qty-${iterStat.index}|"
											th:name="|ingredients[${iterStat.index}].quantityNeeded|"
											th:value="${#numbers.formatDecimal(ingredient.quantityNeeded,1,2)}"
											placeholder="Qty" required>
									</div>
									<div class="col-md-2 text-end">
										<button type="button"
											class="btn btn-sm btn-outline-danger remove-ingredient-btn"
											title="Remove Ingredient">
											<i class="fa-solid fa-times"></i>
										</button>
									</div>
								</div>
								<div th:if="${#fields.hasErrors('ingredients*')}"
									class="alert alert-danger small p-2 mt-2">Errors in
									ingredients list. Please check items and quantities.</div>
							</div>
							<button type="button" class="btn btn-sm btn-outline-success mt-2"
								id="addIngredientBtnEdit">
								<i class="fa-solid fa-plus me-1"></i> Add Ingredient
							</button>

							<div class="d-flex justify-content-end gap-2 mt-4">
								<a th:href="@{/admin/products}" class="btn btn-secondary">Cancel</a>
								<button type="submit" class="btn btn-primary">Save
									Changes</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<template id="ingredientRowTemplateEdit">
			<div class="row ingredient-row mb-2 gx-2 align-items-center">
				<div class="col-md-6">
					<label class="visually-hidden">Ingredient</label> <select
						class="form-select form-select-sm ingredient-item"
						name="ingredients[INDEX].inventoryItemId" required>
						<option value="">-- Select Ingredient --</option>
						<option th:each="invItem : ${inventoryItems}"
							th:value="${invItem.id}"
							th:text="${invItem.name + ' (' + invItem.unit.abbreviation + ')'}"></option>
					</select>
				</div>
				<div class="col-md-4">
					<label class="visually-hidden">Quantity</label> <input
						type="number" step="0.01" min="0.01"
						class="form-control form-control-sm ingredient-quantity"
						name="ingredients[INDEX].quantityNeeded" placeholder="Qty"
						required>
				</div>
				<div class="col-md-2 text-end">
					<button type="button"
						class="btn btn-sm btn-outline-danger remove-ingredient-btn"
						title="Remove Ingredient">
						<i class="fa-solid fa-times"></i>
					</button>
				</div>
			</div>
		</template>

	</main>
</body>
</html>