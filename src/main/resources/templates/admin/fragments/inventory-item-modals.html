<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
	<div th:fragment="all-inventory-item-modals">

		<div class="modal fade" id="addItemModal" tabindex="-1"
			aria-labelledby="addItemModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form th:action="@{/admin/inventory/save}" method="post"
						th:object="${inventoryItemDto}" id="itemForm" novalidate>
						
						<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
						
						<input type="hidden" th:field="*{id}" id="itemId">
						<div class="modal-header">
							<h5 class="modal-title" id="addItemModalLabel">Add/Edit
								Inventory Item</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="mb-3">
								<label for="itemName" class="form-label">Item Name</label> <input
									type="text" class="form-control" th:field="*{name}"
									id="itemName"
									th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''">
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Name
									Error</div>
							</div>
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="itemCategory" class="form-label">Category</label> <select
										class="form-select" th:field="*{categoryId}" id="itemCategory"
										th:classappend="${#fields.hasErrors('categoryId')} ? 'is-invalid' : ''">
										<option value="">-- Select Category --</option>
										<option th:each="cat : ${inventoryCategories}"
											th:value="${cat.id}" th:text="${cat.name}"></option>
									</select>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('categoryId')}"
										th:errors="*{categoryId}">Category Error</div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="itemCost" class="form-label">Cost Per Unit</label>
									<div class="input-group"
										th:classappend="${#fields.hasErrors('costPerUnit')} ? 'is-invalid' : ''">
										<span class="input-group-text">₱</span> <input type="number"
											step="0.01" min="0.01" class="form-control" th:field="*{costPerUnit}"
											id="itemCost"
											th:classappend="${#fields.hasErrors('costPerUnit')} ? 'is-invalid' : ''">
									</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('costPerUnit')}"
										th:errors="*{costPerUnit}">Cost Error</div>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="itemUnit" class="form-label">Unit of
										Measure</label> <select class="form-select" th:field="*{unitId}"
										id="itemUnit"
										th:classappend="${#fields.hasErrors('unitId')} ? 'is-invalid' : ''">
										<option value="">-- Select Unit --</option>
										<option th:each="unit : ${unitsOfMeasure}"
											th:value="${unit.id}"
											th:text="${unit.name + ' (' + unit.abbreviation + ')'}"></option>
									</select>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('unitId')}" th:errors="*{unitId}">Unit
										Error</div>
								</div>
								
								<div class="col-md-6 mb-3">
									<label for="itemStatus" class="form-label">Item Status</label> 
									<select class="form-select" th:field="*{itemStatus}" id="itemStatus"
											th:classappend="${#fields.hasErrors('itemStatus')} ? 'is-invalid' : ''">
										<option value="ACTIVE">ACTIVE</option>
										<option value="INACTIVE">INACTIVE</option>
									</select>
									<div class="invalid-feedback" th:if="${#fields.hasErrors('itemStatus')}" th:errors="*{itemStatus}">Status Error</div>
								</div>
							</div>
							
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="itemReceivedDate" class="form-label">Received/Created Date</label>
									<input type="date" class="form-control" th:field="*{receivedDate}" id="itemReceivedDate"
										th:classappend="${#fields.hasErrors('receivedDate')} ? 'is-invalid' : ''">
									<div class="form-text">Defaults to today if left blank.</div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="itemExpirationDays" class="form-label">Expiration (Days)</label>
									<div class="input-group" th:classappend="${#fields.hasErrors('expirationDays')} ? 'is-invalid' : ''">
										<input type="number" class="form-control" th:field="*{expirationDays}" id="itemExpirationDays" min="0" placeholder="0"
											th:classappend="${#fields.hasErrors('expirationDays')} ? 'is-invalid' : ''">
										<span class="input-group-text">days</span>
									</div>
									<div class="form-text">0 = No expiration.</div>
									<div class="invalid-feedback" th:if="${#fields.hasErrors('expirationDays')}" th:errors="*{expirationDays}">Error</div>
								</div>
							</div>

							<hr>
							<h6 class="mb-3">Item Thresholds</h6>
							<div class="row">
								<div class="col-md-6 mb-3 threshold-group"
									data-threshold-type="low">
									<label for="itemLowThreshold" class="form-label">Low
										Item Threshold</label>
									<div class="d-flex align-items-center gap-2">
										<input type="number" step="1" min="1"
											class="form-control threshold-input"
											th:field="*{lowStockThreshold}" id="itemLowThreshold"
											th:classappend="${#fields.hasErrors('lowStockThreshold')} ? 'is-invalid' : ''">
										<input type="range" class="form-range threshold-slider"
											min="0" max="100" step="1" id="itemLowThresholdSlider">
									</div>
									<div class="form-text">Status: Low at/below this level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('lowStockThreshold')}"
										th:errors="*{lowStockThreshold}">Low Threshold Error</div>
								</div>
								<div class="col-md-6 mb-3 threshold-group"
									data-threshold-type="critical">
									<label for="itemCriticalThreshold" class="form-label">Critical
										Item Threshold</label>
									<div class="d-flex align-items-center gap-2">
										<input type="number" step="1" min="1"
											class="form-control threshold-input"
											th:field="*{criticalStockThreshold}"
											id="itemCriticalThreshold"
											th:classappend="${#fields.hasErrors('criticalStockThreshold')} ? 'is-invalid' : ''">
										<input type="range" class="form-range threshold-slider"
											min="0" max="100" step="1" id="itemCriticalThresholdSlider">
									</div>
									<div class="form-text">Status: Critical at/below this
										level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('criticalStockThreshold')}"
										th:errors="*{criticalStockThreshold}">Critical Threshold
										Error</div>
								</div>
							</div>

							<div id="itemStockInfoContainer" style="display: none;"
								class="mt-3">
								<label class="form-label">Current Stock</label>
								<div class="alert alert-info small py-2">Current stock
									cannot be edited here. Use "Manage Stock".</div>
								<input type="hidden" id="itemCurrentStockHidden"
									th:field="*{currentStock}">
							</div>

						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-custom">Save
								Changes</button>
							<button type="button" class="btn btn-custom-secondary"
								data-bs-dismiss="modal">Cancel</button>

						</div>
					</form>
				</div>
			</div>
		</div>

		
		<div class="modal fade" id="manageStockModal" tabindex="-1"
			aria-labelledby="manageStockModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl modal-dialog-scrollable"> 
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="manageStockModalLabel">Manage
							Inventory Stock</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div th:if="${stockError}"
							class="alert alert-danger alert-dismissible fade show"
							role="alert">
							<i class="fa-solid fa-triangle-exclamation me-2"></i> <span
								th:text="${stockError}"></span>
							<button type="button" class="btn-close" data-bs-dismiss="alert"
								aria-label="Close"></button>
						</div>
						<p class="small text-muted">Adjust stock levels manually. Select a reason to categorize the adjustment.</p>
						<div class="table-responsive">
							<table class="table table-sm align-middle">
								<thead>
									<tr>
										<th>Item Name</th>
										<th>Current Stock</th>
										<th>Unit</th>
										<th style="width: 120px;">Quantity</th>
										<th style="width: 150px;">Reason</th>
										<th>Note</th>
										<th style="width: 140px;">Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="item : ${allInventoryItems}">
										<form th:action="@{/admin/inventory/stock/adjust}"
											method="post" class="stock-adjust-form">
											
											<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
											<input type="hidden" name="inventoryItemId" th:value="${item.id}" />
											
											<input type="hidden" name="expirationDays" th:value="${item.getExpirationDays()}" />
											<td th:text="${item.name}">Item Name</td>
											<td th:text="${#numbers.formatDecimal(item.currentStock, 1, 'COMMA', 2, 'POINT')}">0.00</td>
											<td th:text="${item.unit.abbreviation}">unit</td>

											<td>
												<input type="number" step="0.01" min="0.01"
													name="quantity" class="form-control form-control-sm"
													placeholder="Qty" required />
											</td>
											
											<td>
												<select name="reasonCategory" class="form-select form-select-sm" required>
													<option value="Manual">Manual Adjust</option>
													<option value="Production">Production</option>
													<option value="Restock">Restock</option>
													<option value="Expired" class="text-danger">Expired</option>
													<option value="Damaged" class="text-danger">Damaged</option>
													<option value="Waste" class="text-danger">Waste/Spoilage</option>
												</select>
											</td>
											
											<td>
												<input type="text" name="reasonNote" class="form-control form-control-sm" placeholder="Optional details...">
											</td>

											<td>
												<div class="d-flex gap-1">
													<button type="submit" name="action" value="add"
														class="btn btn-sm btn-action-success w-50">Add</button>
													<button type="submit" name="action" value="deduct"
														class="btn btn-sm btn-action-delete w-50">Deduct</button>
												</div>
											</td>
										</form>
									</tr>
									<tr th:if="${#lists.isEmpty(allInventoryItems)}">
										<td colspan="7" class="text-center text-muted">No
											inventory items found. Add items first.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-custom-secondary"
							data-bs-dismiss="modal">Cancel</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="viewItemModal" tabindex="-1"
			aria-labelledby="viewItemModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="viewItemModalLabel">Item Details</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<h4 id="viewItemName" class="mb-1">Item Name</h4>
						<p class="mb-3">
							<span class="status-badge" id="viewItemStatusBadge">Status</span>
						</p>
						<p>
							<strong>Category:</strong> <span id="viewItemCategory"></span>
						</p>
						<p>
							<strong>Unit:</strong> <span id="viewItemUnit"></span>
						</p>
						<hr>
						<h5 class="mb-3">Stock & Cost Details</h5>
						<div class="row">
							<div class="col-6">
								<p class="mb-1">
									<strong>Current Stock:</strong>
								</p>
								<p class="fs-5 fw-bold" id="viewItemCurrentStock">0.00</p>
							</div>
							<div class="col-6">
								<p class="mb-1">
									<strong>Cost / Unit:</strong>
								</p>
								<p class="fs-5 fw-bold" id="viewItemCostPerUnit">₱0.00</p>
							</div>
						</div>
						<p class="mb-3">
							<strong>Total Cost Value:</strong> <span class="fs-5 fw-bold"
								id="viewItemTotalCostValue">₱0.00</span>
						</p>
						<p class="mb-1">
							<strong>Low Stock Threshold:</strong> <span
								id="viewItemLowThreshold">0.00</span>
						</p>
						<p class="mb-1">
							<strong>Critical Stock Threshold:</strong> <span
								id="viewItemCriticalThreshold">0.00</span>
						</p>
						<p class="mb-1">
							<strong>Item Status:</strong> <span id="viewItemActiveStatus"></span>
						</p>
						
						<hr>

						<h5 class="mb-3">Date & Expiration</h5>
						<p class="mb-1">
							<strong>Received/Created Date:</strong> <span id="viewItemReceivedDate"></span>
						</p>
						
						<p class="mb-1">
							<strong>Last Stock Updated:</strong> <span id="viewItemLastUpdated">N/A</span>
						</p>
						
						<p class="mb-1">
							<strong>Expiration Days:</strong> <span id="viewItemExpirationDays"></span>
						</p>
						<p class="mb-1">
							<strong>Expiration Date:</strong> <span id="viewItemExpirationDate" class="fw-bold"></span>
						</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-custom-secondary"
							data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

	</div>
</body>
</html>