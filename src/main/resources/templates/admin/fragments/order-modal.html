<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

	<div th:fragment="order-view-modal">

		<div class="modal fade" id="viewOrderModal" tabindex="-1"
			aria-labelledby="viewOrderModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="viewOrderModalLabel">Order Details</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-md-8">
								<h4 class="mb-1" id="viewOrderTitle">Order #ORD-XXXX</h4>
								<p class="mb-3">
									<span class="status-badge" id="viewOrderStatusBadge">STATUS</span>
								</p>
							</div>
							<div class="col-md-4 text-md-end">
								<p class="mb-1">
									<strong>Total:</strong> <span
										class="fs-5 fw-bold text-primary" id="viewOrderTotal">₱0.00</span>
								</p>
								<p class="text-muted small" id="viewOrderDate">Date</p>
							</div>
						</div>

						<hr>

						<div class="row">
							<div class="col-md-6">
								<h6 class="mb-3">Customer & Delivery</h6>
								<p class="mb-1">
									<strong>Customer:</strong> <span id="viewCustomerName"></span>
								</p>
								<p class="mb-1">
									<strong>Phone:</strong> <span id="viewCustomerPhone"></span>
								</p>
								<p class="mb-1">
									<strong>Address:</strong> <span id="viewCustomerAddress"></span>
								</p>
								<div id="viewNotesContainer" style="display: none;">
									<p class="mb-1 mt-3">
										<strong>Notes:</strong>
									</p>
									<p class="text-muted small" id="viewOrderNotes"></p>
								</div>
							</div>
							<div class="col-md-6">
								<h6 class="mb-3">Payment</h6>
								<p class="mb-1">
									<strong>Method:</strong> <span id="viewPaymentMethod"></span>
								</p>
								<p class="mb-1">
									<strong>Status:</strong> <span id="viewPaymentStatus"></span>
								</p>
								
								<div id="viewTransactionIdContainer" class="mt-3" style="display: none;">
									<p class="mb-1">
										<strong>Transaction ID:</strong> 
										<span id="viewTransactionId" class="fw-bold"></span>
									</p>
								</div>
								<div id="viewReceiptContainer" class="mt-3"
									style="display: none;">
									<p class="mb-1">
										<strong>GCash Receipt:</strong>
									</p>
									<a id="viewReceiptLink" href="#" target="_blank"
										title="Click to view full image"> <img
										id="viewReceiptImage" src="" alt="GCash Receipt"
										class="img-fluid rounded border"
										style="max-height: 200px; object-fit: contain;">
									</a>
								</div>
							</div>
						</div>

						<hr>

						<h6 class="mb-3">Order Items</h6>
						<table class="table table-sm">
							<thead>
								<tr>
									<th>Product</th>
									<th class="text-center">Quantity</th>
									<th class="text-end">Price</th>
									<th class="text-end">Subtotal</th>
								</tr>
							</thead>
							<tbody id="viewOrderItemsList">
								</tbody>
							<tfoot>
								<tr>
									<td colspan="3" class="text-end fw-bold"><strong>Total</strong></td>
									<td class="text-end fw-bold"><strong id="viewOrderTotalFooter">₱0.00</strong></td>
								</tr>
							</tfoot>
						</table>

					</div>
					<div class="modal-footer">
						<div class="d-flex gap-2 me-auto" id="orderDocumentButtons">
							</div>
						<button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function() {
				const viewOrderModal = document.getElementById('viewOrderModal');
				if (viewOrderModal) {
					viewOrderModal.addEventListener('show.bs.modal', function(event) {
						const button = event.relatedTarget;
						const row = button.closest('tr');
						const orderId = row ? row.dataset.orderId : null;
						const orderStatus = row ? row.dataset.orderStatus : null;

						const container = viewOrderModal.querySelector('#orderDocumentButtons');
						container.innerHTML = '';
						
						if (orderId && orderStatus && orderStatus !== 'CANCELLED' && orderStatus !== 'REJECTED') {
							// 1. Invoice button (visible if order status is anything but PENDING/CANCELLED/REJECTED)
							const invoiceButton = document.createElement('a');
							invoiceButton.href = '/admin/reports/download/invoice/' + orderId;
							invoiceButton.target = '_blank';
							invoiceButton.className = 'btn btn-action-view';
							invoiceButton.innerHTML = '<i class="fa-solid fa-file-invoice me-1"></i> Invoice';
							container.appendChild(invoiceButton);

							// 2. Receipt button (only visible if DELIVERED)
							if (orderStatus === 'DELIVERED') {
								const receiptButton = document.createElement('a');
								receiptButton.href = '/admin/reports/download/receipt/' + orderId;
								receiptButton.target = '_blank';
								receiptButton.className = 'btn btn-action-view';
								receiptButton.innerHTML = '<i class="fa-solid fa-receipt me-1"></i> Receipt';
								container.appendChild(receiptButton);
							}
						}
					});
				}
			});
		</script>
	</div>
</body>
</html>