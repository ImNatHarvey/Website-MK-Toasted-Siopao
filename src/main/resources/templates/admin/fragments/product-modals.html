<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

	<div th:fragment="all-product-modals">

		<div class="modal fade" id="addProductModal" tabindex="-1"
			aria-labelledby="addProductModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form th:action="@{/admin/products/add}" method="post"
						th:object="${productDto}" id="addProductForm"
						enctype="multipart/form-data"
						data-confirm-save-message="Adding this product will lock its ingredients. Once added, the ingredients can no longer be modified. Proceed?">
						<div class="modal-header">
							<h5 class="modal-title" id="addProductModalLabel">Add New
								Product</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div th:if="${#fields.hasErrors('productDto.*')}"
								class="alert alert-danger small p-2" role="alert">Please
								correct the errors below.</div>
							<div class="mb-3">
								<label for="addProductName" class="form-label">Product
									Name</label> <input type="text" class="form-control" th:field="*{name}"
									id="addProductName" th:errorclass="is-invalid">
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('name')}" th:errors="*{name}">...</div>
							</div>
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="addProductCategory" class="form-label">Category</label>
									<select class="form-select" th:field="*{categoryId}"
										id="addProductCategory" th:errorclass="is-invalid">
										<option value="">-- Select a Category --</option>
										<option th:each="cat : ${categories}" th:value="${cat.id}"
											th:text="${cat.name}">Category</option>
									</select>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('categoryId')}"
										th:errors="*{categoryId}">...</div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="addProductPrice" class="form-label">Price</label>
									<div class="input-group">
										<span class="input-group-text">₱</span> <input type="number"
											step="0.01" min="0" class="form-control" th:field="*{price}"
											id="addProductPrice" th:errorclass="is-invalid">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('price')}" th:errors="*{price}">...</div>
									</div>
								</div>
							</div>
							<div class="mb-3">
								<label for="addProductDescription" class="form-label">Description
									(Optional)</label>
								<textarea class="form-control" th:field="*{description}"
									id="addProductDescription" rows="2" th:errorclass="is-invalid"></textarea>
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('description')}"
									th:errors="*{description}">...</div>
							</div>

							<div class="mb-3">
								<label class="form-label">Product Image (Optional)</label>
								<div class="image-uploader-container" id="addImageUploader">
									<input type="file" name="imageFile"
										class="image-uploader-input" accept="image/png, image/jpeg">
									<div class="image-drop-zone">
										<i class="fa-solid fa-cloud-arrow-up text-muted"></i>
										<p class="mb-0">
											<strong>Choose a file</strong> or drag it here.
										</p>
									</div>
									<div class="image-preview-container">
										<img src="" alt="Image Preview" class="image-preview">
										<button type="button"
											class="btn btn-sm btn-danger image-remove-btn"
											title="Remove Image">
											<i class="fa-solid fa-trash"></i>
										</button>
									</div>
								</div>
							</div>
							<hr class="my-4">
							<h5 class="mb-3">Product Thresholds</h5>
							<div class="row">
								<div class="col-md-6 mb-3 threshold-group"
									data-threshold-type="low">
									<label for="addLowThresholdInput" class="form-label">Low
										Product Threshold</label>
									<div class="d-flex align-items-center gap-2">
										<input type="number" step="1" min="0" max="999"
											class="form-control threshold-input"
											th:field="*{lowStockThreshold}" id="addLowThresholdInput"
											th:errorclass="is-invalid"> <input type="range"
											class="form-range threshold-slider" min="0" max="100"
											step="1" id="addLowThresholdSlider">
									</div>
									<div class="form-text">Status: Low at/below this level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('lowStockThreshold')}"
										th:errors="*{lowStockThreshold}"></div>
								</div>
								<div class="col-md-6 mb-3 threshold-group"
									data-threshold-type="critical">
									<label for="addCriticalThresholdInput" class="form-label">Critical
										Product Threshold</label>
									<div class="d-flex align-items-center gap-2">
										<input type="number" step="1" min="0" max="999"
											class="form-control threshold-input"
											th:field="*{criticalStockThreshold}"
											id="addCriticalThresholdInput" th:errorclass="is-invalid">
										<input type="range" class="form-range threshold-slider"
											min="0" max="100" step="1" id="addCriticalThresholdSlider">
									</div>
									<div class="form-text">Status: Critical at/below this
										level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('criticalStockThreshold')}"
										th:errors="*{criticalStockThreshold}"></div>
								</div>
								<div class="col-12">
									<div class="invalid-feedback d-block"
										th:if="${#fields.hasGlobalErrors()}" th:errors="*{global}"></div>
								</div>
							</div>

							<hr class="my-4">
							<h5 class="mb-3">Recipe Ingredients</h5>
							<div id="addIngredientsContainer">
								<div th:each="ing, iterStat : *{ingredients}"
									class="row ingredient-row mb-2 gx-2 align-items-center">
									<div class="col-md-7">
										<select class="form-select form-select-sm ingredient-item"
											th:field="*{ingredients[__${iterStat.index}__].inventoryItemId}"
											th:errorclass="is-invalid" required>
											<option value="">-- Select Ingredient --</option>
											<option th:each="item : ${inventoryItems}"
												th:value="${item.id}"
												th:text="${item.name + ' (' + item.unit.abbreviation + ')'}">
												Item Name (unit)</option>
										</select>
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('ingredients[__${iterStat.index}__].inventoryItemId')}"
											th:errors="*{ingredients[__${iterStat.index}__].inventoryItemId}"></div>
									</div>
									<div class="col-md-3">
										<input type="number" step="0.01" min="0.01"
											class="form-control form-control-sm ingredient-quantity"
											th:field="*{ingredients[__${iterStat.index}__].quantityNeeded}"
											placeholder="Qty per unit" th:errorclass="is-invalid"
											required>
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('ingredients[__${iterStat.index}__].quantityNeeded')}"
											th:errors="*{ingredients[__${iterStat.index}__].quantityNeeded}"></div>
									</div>
									<div class="col-md-2">
										<button type="button"
											class="btn btn-sm btn-action-delete w-100 remove-ingredient-btn">
											<i class="fa-solid fa-trash"></i>
										</button>
									</div>
								</div>

								<div th:if="${#fields.hasErrors('ingredients')}"
									class="alert alert-danger small p-2 mt-2"
									th:errors="*{ingredients}">Ingredient list error.</div>
							</div>
							<button type="button" class="btn btn-sm btn-action-success mt-2"
								id="addIngredientBtn">
								<i class="fa-solid fa-plus me-1"></i> Add Ingredient
							</button>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-custom">Add Product</button>
							<button type="button" class="btn btn-custom-secondary"
								data-bs-dismiss="modal">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div class="modal fade" id="editProductModal" tabindex="-1"
			aria-labelledby="editProductModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form th:action="@{/admin/products/update}" method="post"
						th:object="${productUpdateDto}" id="editProductForm"
						enctype="multipart/form-data">
						<div class="modal-header">
							<h5 class="modal-title" id="editProductModalLabel">Edit
								Product</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" th:field="*{id}" /> <input type="hidden"
								th:field="*{imageUrl}" id="editProductImageUrlHidden" /> <input
								type="hidden" th:field="*{removeImage}"
								id="editProductRemoveImageHidden" />
							<div class="mb-3">
								<label for="editProductNameModal" class="form-label">Product
									Name</label> <input type="text" class="form-control" th:field="*{name}"
									id="editProductNameModal" th:errorclass="is-invalid">
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
							</div>
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="editProductCategoryModal" class="form-label">Category</label>
									<select class="form-select" th:field="*{categoryId}"
										id="editProductCategoryModal" th:errorclass="is-invalid">
										<option value="">-- Select a Category --</option>
										<option th:each="cat : ${categories}" th:value="${cat.id}"
											th:text="${cat.name}"></option>
									</select>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('categoryId')}"
										th:errors="*{categoryId}"></div>
								</div>
								<div class="col-md-6 mb-3">
									<label for="editProductPriceModal" class="form-label">Price</label>
									<div class="input-group">
										<span class="input-group-text">₱</span> <input type="number"
											step="0.01" min="0" class="form-control" th:field="*{price}"
											id="editProductPriceModal" th:errorclass="is-invalid">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
									</div>
								</div>
							</div>
							<div class="mb-3">
								<label for="editProductDescriptionModal" class="form-label">Description
									(Optional)</label>
								<textarea class="form-control" th:field="*{description}"
									id="editProductDescriptionModal" rows="2"
									th:errorclass="is-invalid"></textarea>
								<div class="invalid-feedback"
									th:if="${#fields.hasErrors('description')}"
									th:errors="*{description}"></div>
							</div>

							<div class="mb-3">
								<label class="form-label">Product Image</label>
								<div class="image-uploader-container" id="editImageUploader">
									<input type="file" name="imageFile"
										class="image-uploader-input" accept="image/png, image/jpeg">
									<div class="image-drop-zone">
										<i class="fa-solid fa-cloud-arrow-up text-muted"></i>
										<p class="mb-0">
											<strong>Choose a file</strong> or drag it here.
										</p>
									</div>
									<div class="image-preview-container">
										<img src="" alt="Image Preview" class="image-preview">
										<button type="button"
											class="btn btn-sm btn-danger image-remove-btn"
											title="Remove Image">
											<i class="fa-solid fa-trash"></i>
										</button>
									</div>
								</div>
							</div>
							<hr class="my-4">
							<h5 class="mb-3">Product Thresholds</h5>
							<div class="row">
								<div class="col-md-6 mb-3 threshold-group"
									data-threshold-type="low">
									<label for="editLowThresholdInput" class="form-label">Low
										Product Threshold</label>
									<div class="d-flex align-items-center gap-2">
										<input type="number" step="1" min="0" max="999"
											class="form-control threshold-input"
											th:field="*{lowStockThreshold}" id="editLowThresholdInput"
											th:errorclass="is-invalid"> <input type="range"
											class="form-range threshold-slider" min="0" max="100"
											step="1" id="editLowThresholdSlider">
									</div>
									<div class="form-text">Status: Low at/below this level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('lowStockThreshold')}"
										th:errors="*{lowStockThreshold}"></div>
								</div>
								<div class="col-md-6 mb-3 threshold-group"
									data-threshold-type="critical">
									<label for="editCriticalThresholdInput" class="form-label">Critical
										Product Threshold</label>
									<div class="d-flex align-items-center gap-2">
										<input type="number" step="1" min="0" max="999"
											class="form-control threshold-input"
											th:field="*{criticalStockThreshold}"
											id="editCriticalThresholdInput" th:errorclass="is-invalid">
										<input type="range" class="form-range threshold-slider"
											min="0" max="100" step="1" id="editCriticalThresholdSlider">
									</div>
									<div class="form-text">Status: Critical at/below this
										level.</div>
									<div class="invalid-feedback"
										th:if="${#fields.hasErrors('criticalStockThreshold')}"
										th:errors="*{criticalStockThreshold}"></div>
								</div>
								<div class="col-12 mb-3" th:if="${#fields.hasGlobalErrors()}">
									<div class="alert alert-danger alert-sm p-2" role="alert"
										th:each="err : ${#fields.globalErrors()}" th:text="${err}">Global
										error</div>
								</div>
							</div>
							<div class="alert alert-info small">Current stock cannot be
								edited here. Use "Manage Stock".</div>

							<hr class="my-4">
							<h5 class="mb-3">Recipe Ingredients</h5>
							<div class="alert alert-warning small p-2" role="alert"
								id="editRecipeLockedWarning" style="display: none;">
								<i class="fa-solid fa-lock me-1"></i> This product's recipe is <strong>locked</strong>.
								Ingredients can no longer be modified.
							</div>
							<div id="editIngredientsContainerModal">
								<div th:each="ing, iterStat : *{ingredients}"
									class="row ingredient-row mb-2 gx-2 align-items-center">
									<div class="col-md-7">
										<select class="form-select form-select-sm ingredient-item"
											th:field="*{ingredients[__${iterStat.index}__].inventoryItemId}"
											th:errorclass="is-invalid" required>
											<option value="">-- Select Ingredient --</option>
											<option th:each="item : ${inventoryItems}"
												th:value="${item.id}"
												th:text="${item.name + ' (' + item.unit.abbreviation + ')'}">
												Item Name (unit)</option>
										</select>
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('ingredients[__${iterStat.index}__].inventoryItemId')}"
											th:errors="*{ingredients[__${iterStat.index}__].inventoryItemId}"></div>
									</div>
									<div class="col-md-3">
										<input type="number" step="0.01" min="0.01"
											class="form-control form-control-sm ingredient-quantity"
											th:field="*{ingredients[__${iterStat.index}__].quantityNeeded}"
											placeholder="Qty per unit" th:errorclass="is-invalid"
											required>
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('ingredients[__${iterStat.index}__].quantityNeeded')}"
											th:errors="*{ingredients[__${iterStat.index}__].quantityNeeded}"></div>
									</div>
									<div class="col-md-2">
										<button type="button"
											class="btn btn-sm btn-action-delete w-100 remove-ingredient-btn">
											<i class="fa-solid fa-trash"></i>
										</button>
									</div>
								</div>

								<div
									th:if="${#fields.hasErrors('*{ingredients}') && !#fields.hasErrors('*{ingredients*}')}"
									class="alert alert-danger small p-2 mt-2"
									th:errors="*{ingredients}">Ingredient list error.</div>
							</div>
							<button type="button" class="btn btn-sm btn-action-success mt-2"
								id="addIngredientBtnEditModal">
								<i class="fa-solid fa-plus me-1"></i> Add Ingredient
							</button>

						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-custom">Save
								Changes</button>
							<button type="button" class="btn btn-custom-secondary"
								data-bs-dismiss="modal">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div class="modal fade" id="manageStockModal" tabindex="-1"
			aria-labelledby="manageStockModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-scrollable">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="manageStockModalLabel">Manage
							Product Stock</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<p class="small text-muted">Record production (increase stock)
							or wastage/adjustments (decrease stock). Use 'Max' to calculate
							the maximum producable quantity based on inventory.</p>
						<div class="table-responsive">
							<table class="table table-sm align-middle">
								<thead>
									<tr>
										<th>Product</th>
										<th>Current Stock</th>
										<th>Quantity</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="prod : ${products}"
										th:data-product-ingredients="${prod.ingredients != null ? #strings.listJoin(prod.ingredients.![inventoryItem.id + ':' + quantityNeeded], ',') : ''}"
										th:data-product-id="${prod.id}">
										<form th:action="@{/admin/products/stock/adjust}"
											method="post" class="stock-adjust-form">
											<input type="hidden" name="productId" th:value="${prod.id}" />
											<td th:text="${prod.name}">...</td>
											<td th:text="${prod.currentStock}">...</td>
											<td><input type="number" name="quantity"
												class="form-control form-control-sm quantity-change-input"
												style="width: 100px;" placeholder="Qty" required step="1"
												min="1" /></td>
											<td>
												<div class="d-flex gap-1">
													<button type="button"
														class="btn btn-sm btn-action-view max-quantity-btn"
														th:if="${prod.ingredients != null and !#lists.isEmpty(prod.ingredients)}"
														title="Calculate maximum producable quantity based on inventory">Max</button>
													<button type="submit" name="action" value="add"
														class="btn btn-sm btn-action-success">Add</button>
													<button type="submit" name="action" value="deduct"
														class="btn btn-sm btn-action-delete">Deduct</button>
												</div>
											</td>
										</form>
									</tr>
									<tr th:if="${#lists.isEmpty(products)}">
										<td colspan="4" class="text-center text-muted">No
											products found.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-custom-secondary"
							data-bs-dismiss="modal">Cancel</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="viewProductModal" tabindex="-1"
			aria-labelledby="viewProductModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="viewProductModalLabel">Product
							Details</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="row mb-4">
							<div class="col-md-4 text-center">
								<img id="viewProductImage" src="/img/placeholder.jpg"
									class="img-fluid rounded mb-2"
									style="max-height: 250px; object-fit: contain;"
									alt="Product Image"
									onerror="this.onerror=null; this.src='/img/placeholder.jpg';">
							</div>
							<div class="col-md-8">
								<h4 id="viewProductName">Product Name</h4>
								<p class="text-muted mb-2" id="viewProductCategory">Category</p>
								<p class="fs-5 fw-bold mb-2">
									₱<span id="viewProductPrice">Price</span>
								</p>
								<p class="mb-2">
									<strong>Description:</strong>
								</p>
								<p id="viewProductDescription">Description...</p>

								<hr>

								<p class="mb-1">
									<strong>Stock Status:</strong> <span class="status-badge ms-2"
										id="viewProductStockStatusBadge">Stock Status</span>
								</p>
								<p class="mb-1">
									<strong>Current Stock:</strong> <span
										id="viewProductCurrentStock">0</span> units
								</p>
								<p class="mb-1">
									<strong>Low Stock Threshold:</strong> <span
										id="viewProductLowThreshold">0</span> units
								</p>
								<p class="mb-1">
									<strong>Critical Stock Threshold:</strong> <span
										id="viewProductCriticalThreshold">0</span> units
								</p>
								<p class="small text-muted" id="viewProductStockLastUpdated">Stock
									last updated: ...</p>
							</div>
						</div>

						<hr>
						<h5 class="mb-3" id="viewProductIngredientsHeading">Recipe
							Ingredients</h5>
						<div id="viewProductIngredientsList">
							<p class="text-muted small">No ingredients assigned.</p>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button"
							class="btn btn-action-edit edit-product-btn-from-view"
							data-bs-dismiss="modal" data-bs-toggle="modal"
							data-bs-target="#editProductModal">
							<i class="fa-solid fa-pencil me-1"></i> Edit Product
						</button>
						<form th:action="@{/admin/products/delete/0}" method="post"
							class="d-inline delete-product-form-from-view"
							data-confirm-message="Are you sure you want to delete this product?">
							<input type="hidden" name="productId"
								class="view-product-id-for-delete" value="" />
							<button type="submit" class="btn btn-action-delete">
								<i class="fa-solid fa-trash me-1"></i> Delete Product
							</button>
							<button type="button" class="btn btn-custom-secondary"
								data-bs-dismiss="modal">Cancel</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<template id="ingredientRowTemplate">
			<div class="row ingredient-row mb-2 gx-2 align-items-center">
				<div class="col-md-7">
					<label class="form-label visually-hidden">Ingredient</label> <select
						class="form-select form-select-sm ingredient-item"
						name="ingredients[INDEX].inventoryItemId" required>
						<option value="">-- Select Ingredient --</option>
						<option th:each="item : ${inventoryItems}" th:value="${item.id}"
							th:text="${item.name + ' (' + item.unit.abbreviation + ')'}">
							Item Name (unit)</option>
					</select>
				</div>
				<div class="col-md-3">
					<label class="form-label visually-hidden">Quantity</label> <input
						type="number" step="0.01" min="0.01"
						class="form-control form-control-sm ingredient-quantity"
						name="ingredients[INDEX].quantityNeeded"
						placeholder="Qty per unit" required>
				</div>
				<div class="col-md-2">
					<button type="button"
						class="btn btn-sm btn-action-delete w-100 remove-ingredient-btn"
						title="Remove Ingredient">
						<i class="fa-solid fa-trash"></i>
					</button>
				</div>
			</div>
		</template>

		<template id="ingredientRowTemplateEditModal">
			<div class="row ingredient-row mb-2 gx-2 align-items-center">
				<div class="col-md-7">
					<label class="form-label visually-hidden">Ingredient</label> <select
						class="form-select form-select-sm ingredient-item"
						name="ingredients[INDEX].inventoryItemId" required>
						<option value="">-- Select Ingredient --</option>
						<option th:each="item : ${inventoryItems}" th:value="${item.id}"
							th:text="${item.name + ' (' + item.unit.abbreviation + ')'}">
							Item Name (unit)</option>
					</select>
				</div>
				<div class="col-md-3">
					<label class="form-label visually-hidden">Quantity</label> <input
						type="number" step="0.01" min="0.01"
						class="form-control form-control-sm ingredient-quantity"
						name="ingredients[INDEX].quantityNeeded"
						placeholder="Qty per unit" required>
				</div>
				<div class="col-md-2">
					<button type="button"
						class="btn btn-sm btn-action-delete w-100 remove-ingredient-btn"
						title="Remove Ingredient">
						<i class="fa-solid fa-trash"></i>
					</button>
				</div>
			</div>
		</template>

	</div>
</body>
</html>