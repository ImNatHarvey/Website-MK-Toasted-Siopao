<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{admin/base :: layout(~{::#admin-content-wrapper}, ~{::script}, 'inventory')}">
<head>
<title>Manage Inventory - MK Admin Portal</title>
</head>
<body>

	<div id="admin-content-wrapper"
		th:attr="data-show-add-item-modal=${#fields.hasErrors('inventoryItemDto.*') ? 'true' : 'false'},
                 data-show-manage-categories-modal=${#fields.hasErrors('inventoryCategoryDto.*') ? 'true' : 'false'},
                 data-show-edit-inv-category-modal=${#fields.hasErrors('inventoryCategoryUpdateDto.*') ? 'true' : 'false'},
                 data-show-manage-units-modal=${#fields.hasErrors('unitOfMeasureDto.*') ? 'true' : 'false'},
                 data-show-edit-unit-modal=${#fields.hasErrors('unitOfMeasureUpdateDto.*') ? 'true' : 'false'},
                 data-show-manage-stock-modal=${stockError != null ? 'true' : 'false'}">
		<div
			class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
			<h1 class="mb-3 mb-md-0 section-title">Inventory Management</h1>
			<div class="d-flex gap-2">
				<button class="btn btn-action-add" data-bs-toggle="modal"
					data-bs-target="#addItemModal">
					<i class="fa-solid fa-plus me-1"></i> Add Item
				</button>
				<button class="btn btn-custom-outline" data-bs-toggle="modal"
					data-bs-target="#manageCategoriesModal">
					<i class="fa-solid fa-tags me-1"></i> Manage Categories
				</button>
				<button class="btn btn-custom-outline" data-bs-toggle="modal"
					data-bs-target="#manageUnitsModal">
					<i class="fa-solid fa-ruler-combined me-1"></i> Manage Units
				</button>
				<button class="btn btn-action-success" data-bs-toggle="modal"
					data-bs-target="#manageStockModal">
					<i class="fa-solid fa-boxes-stacked me-1"></i> Manage Stock
				</button>
			</div>
		</div>

		<div th:replace="~{admin/fragments/common-alerts :: inventoryAlerts}"></div>
		<div th:replace="~{admin/fragments/common-alerts :: categoryAlerts}"></div>
		<div th:replace="~{admin/fragments/common-alerts :: unitAlerts}"></div>
		<div th:replace="~{admin/fragments/common-alerts :: stockAlerts}"></div>

		<div class="row text-center mb-4">
			<div class="col-md-3 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Total Items</h5>
						<p class="display-6 fw-bold" th:text="${totalItems}">0</p>
					</div>
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Total Inventory Value</h5>
						<p class="display-6 fw-bold"
							th:text="'₱' + ${#numbers.formatDecimal(totalInventoryValue, 1, 'COMMA', 2, 'POINT')}">
							₱0.00</p>
					</div>
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Items Low</h5>
						<p class="display-6 fw-bold text-warning"
							th:text="${lowStockCount}">0</p>
					</div>
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class_w="card-title">Items Out of Stock</h5>
						<p class="display-6 fw-bold text-danger"
							th:text="${outOfStockCount}">0</p>
					</div>
				</div>
			</div>
		</div>
		<form th:action="@{/admin/inventory}" method="get"
			class="mb-4 p-3 bg-light rounded shadow-sm">
			<div class="row g-3 align-items-end">
				<div class="col-md-5">
					<label for="keyword" class="form-label">Search by Item Name</label>
					<input type="text" class="form-control" id="keyword" name="keyword"
						placeholder="Enter item name..." th:value="${keyword}">
				</div>
				<div class="col-md-5">
					<label for="category" class="form-label">Filter by Category</label>
					<select class="form-select" id="category" name="category">
						<option value="">-- All Categories --</option>
						<option th:each="cat : ${inventoryCategories}"
							th:value="${cat.id}" th:text="${cat.name}"
							th:selected="${selectedCategoryId != null && selectedCategoryId == cat.id}">
							Category Name</option>
					</select>
				</div>
				<div class="col-md-2 d-flex justify-content-end">
					<button type="submit" class="btn btn-action-view me-2">
						<i class="fa-solid fa-search me-1"></i> Search
					</button>
					<a th:href="@{/admin/inventory}" class="btn btn-custom-secondary"
						title="Clear Filters">Clear </a>
				</div>
			</div>
		</form>

		<div class="card shadow-sm mb-4">
			<div class="card-header">
				<h5 class="mb-0">Inventory Items</h5>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover align-middle text-center">
						<thead class="table-light">
							<tr>
								<th>Item Name</th>
								<th>Category</th>
								<th>Current Stock</th>
								<th>Unit</th>
								<th>Cost Per Unit</th>
								<th>Total Cost</th>
								<th>Status</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="item : ${inventoryItems}">
								<td th:text="${item.name}">Flour</td>
								<td th:text="${item.category.name}">Dry Ingredients</td>
								<td
									th:text="${#numbers.formatDecimal(item.currentStock, 1, 'COMMA', 2, 'POINT')}">25.00</td>
								<td th:text="${item.unit.abbreviation}">kg</td>
								<td
									th:text="'₱' + ${#numbers.formatDecimal(item.costPerUnit, 1, 'COMMA', 2, 'POINT')}">₱50.00</td>
								<td
									th:text="'₱' + ${#numbers.formatDecimal(item.getTotalCostValue(), 1, 'COMMA', 2, 'POINT')}">₱1,250.00</td>
								<td><span class="status-badge"
									th:text="${#strings.replace(item.stockStatus, '_', ' ')}"
									th:classappend="'status-' + ${#strings.toLowerCase(item.stockStatus)}">
										Status </span></td>
								<td class="d-flex justify-content-center gap-2">
									<button class="btn btn-sm btn-action-view view-item-btn"
										data-bs-toggle="modal" data-bs-target="#viewItemModal"
										th:data-name="${item.name}"
										th:data-category-name="${item.category.name}"
										th:data-unit-name="${item.unit.name + ' (' + item.unit.abbreviation + ')'}"
										th:data-current-stock="${#numbers.formatDecimal(item.currentStock, 1, 'COMMA', 2, 'POINT')}"
										th:data-cost-per-unit="${#numbers.formatDecimal(item.costPerUnit, 1, 'COMMA', 2, 'POINT')}"
										th:data-total-cost-value="${#numbers.formatDecimal(item.getTotalCostValue(), 1, 'COMMA', 2, 'POINT')}"
										th:data-low-threshold="${#numbers.formatDecimal(item.lowStockThreshold, 1, 'COMMA', 2, 'POINT')}"
										th:data-critical-threshold="${#numbers.formatDecimal(item.criticalStockThreshold, 1, 'COMMA', 2, 'POINT')}"
										th:data-stock-status="${#strings.replace(item.stockStatus, '_', ' ')}"
										th:data-stock-status-class="'status-' + ${#strings.toLowerCase(item.stockStatus)}"
										th:data-last-updated="${item.lastUpdated != null ? #temporals.format(item.lastUpdated, 'MMM dd, yyyy HH:mm') : 'N/A'}">
										View</button>
									<button class="btn btn-sm btn-action-edit edit-item-btn"
										data-bs-toggle="modal" data-bs-target="#addItemModal"
										th:data-id="${item.id}" th:data-name="${item.name}"
										th:data-category-id="${item.category.id}"
										th:data-unit-id="${item.unit.id}"
										th:data-current-stock="${#numbers.formatDecimal(item.currentStock, 1, 2)}"
										th:data-low-threshold="${#numbers.formatDecimal(item.lowStockThreshold, 1, 2)}"
										th:data-critical-threshold="${#numbers.formatDecimal(item.criticalStockThreshold, 1, 2)}"
										th:data-cost="${item.costPerUnit != null ? #numbers.formatDecimal(item.costPerUnit, 1, 2) : ''}">
										Edit</button>
									<form
										th:action="@{/admin/inventory/delete/{id}(id=${item.id})}"
										method="post"
										th:data-confirm-message="'Are you sure you want to delete the item \'' + ${item.name} + '\'?'">
										<button type="submit" class="btn btn-sm btn-action-delete">Delete</button>
									</form>
								</td>
							</tr>
							<tr th:if="${#lists.isEmpty(inventoryItems)}">
								<td colspan="8" class="text-center text-muted"
									th:text="${(keyword != null or selectedCategoryId != null) ? 'No items found matching your criteria.' : 'No inventory items added yet.'}">
									No inventory items added yet.</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div th:if="${inventoryPage.totalPages > 0}"
					class="d-flex justify-content-between align-items-center mt-3">

					<span class="text-muted small"
						th:text="'Showing ' + ${inventoryPage.number * inventoryPage.size + 1} + 
                               ' - ' + ${inventoryPage.number * inventoryPage.size + inventoryPage.numberOfElements} + 
                               ' of ' + ${inventoryPage.totalElements}">
					</span>

					<nav aria-label="Inventory Pagination">
						<ul class="pagination pagination-sm mb-0">
							<li class="page-item"
								th:classappend="${inventoryPage.first} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/inventory(page=${inventoryPage.number - 1}, size=${size}, keyword=${keyword}, category=${selectedCategoryId})}">Previous</a>
							</li>

							<th:block
								th:each="i : ${#numbers.sequence(0, inventoryPage.totalPages - 1)}"
								th:if="${inventoryPage.totalPages <= 7 || i == 0 || i == inventoryPage.totalPages - 1 || (i >= inventoryPage.number - 2 && i <= inventoryPage.number + 2)}">

								<li class="page-item disabled"
									th:if="${inventoryPage.totalPages > 7 && (i == 0 && inventoryPage.number > 3 || i == inventoryPage.totalPages - 1 && inventoryPage.number < inventoryPage.totalPages - 4)}">
									<span class="page-link">...</span>
								</li>

								<li class="page-item"
									th:classappend="${i == inventoryPage.number} ? 'active'"><a
									class="page-link"
									th:href="@{/admin/inventory(page=${i}, size=${size}, keyword=${keyword}, category=${selectedCategoryId})}"
									th:text="${i + 1}"></a></li>
							</th:block>

							<li class="page-item"
								th:classappend="${inventoryPage.last} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/inventory(page=${inventoryPage.number + 1}, size=${size}, keyword=${keyword}, category=${selectedCategoryId})}">Next</a>
							</li>
						</ul>
					</nav>

					<span class="text-muted small" style="visibility: hidden;"
						th:text="'Showing ' + ${inventoryPage.number * inventoryPage.size + 1} + 
                               ' - ' + ${inventoryPage.number * inventoryPage.size + inventoryPage.numberOfElements} + 
                               ' of ' + ${inventoryPage.totalElements}">
					</span>
				</div>
			</div>
		</div>

		<div
			th:replace="~{admin/fragments/inventory-item-modals :: all-inventory-item-modals}"></div>
		<div
			th:replace="~{admin/fragments/inventory-category-modals :: all-inventory-category-modals}"></div>
		<div th:replace="~{admin/fragments/unit-modals :: all-unit-modals}"></div>

	</div>
	<th:block th:fragment="script">
		<script th:src="@{/js/admin-inventory.js}"></script>
	</th:block>

</body>
</html>