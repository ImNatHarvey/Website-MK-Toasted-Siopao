<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	th:replace="~{admin/base :: layout(~{::#admin-content-wrapper}, ~{::script}, 'orders')}">
<head>
<title>Manage Orders - MK Admin Portal</title>
</head>
<body>

	<div id="admin-content-wrapper">
		<div
			class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
			<h1 class="mb-3 mb-md-0 section-title">Order Management</h1>
		</div>

		<div
			th:replace="~{admin/fragments/common-alerts :: all-alerts-as-toasts}"></div>

		<div class="row text-center mb-4">
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Total Orders</h5>
						<p class="display-6 fw-bold" th:text="${totalOrders}">0</p>
					</div>
				</div>
			</div>
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Pending (GCASH)</h5>
						<p class="display-6 fw-bold"
							th:text="${pendingVerificationOrders}"
							style="color: var(--primary);">0</p>
					</div>
				</div>
			</div>
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Pending (COD)</h5>
						<p class="display-6 fw-bold text-warning"
							th:text="${pendingOrders}">0</p>
					</div>
				</div>
			</div>
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Processing</h5>
						<p class="display-6 fw-bold text-info"
							th:text="${processingOrders}">0</p>
					</div>
				</div>
			</div>
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Out for Delivery</h5>
						<p class="display-6 fw-bold" style="color: #13c2c2;"
							th:text="${outForDeliveryOrders}">0</p>
					</div>
				</div>
			</div>
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Delivered</h5>
						<p class="display-6 fw-bold text-success"
							th:text="${deliveredOrders}">0</p>
					</div>
				</div>
			</div>
			<div class="col-lg col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Cancelled/Rejected</h5>
						<p class="display-6 fw-bold text-danger"
							th:text="${cancelledOrders + rejectedOrders}">0</p>
					</div>
				</div>
			</div>
		</div>

		<div class="d-flex justify-content-center flex-wrap gap-2 mb-4">
			<a th:href="@{/admin/orders}" class="btn btn-outline-primary"
				th:classappend="${currentStatus == null ? 'active' : ''}">All
				Orders</a> <a
				th:href="@{/admin/orders(status='PENDING_VERIFICATION')}"
				class="btn btn-outline-primary"
				style="--bs-btn-color: var(--primary); --bs-btn-border-color: var(--primary); color: var(--primary);"
				th:classappend="${currentStatus == 'PENDING_VERIFICATION' ? 'active' : ''}">
				Pending (GCASH) </a> <a th:href="@{/admin/orders(status='PENDING')}"
				class="btn btn-outline-warning"
				th:classappend="${currentStatus == 'PENDING' ? 'active' : ''}">Pending
				(COD)</a> <a th:href="@{/admin/orders(status='PROCESSING')}"
				class="btn btn-outline-info"
				th:classappend="${currentStatus == 'PROCESSING' ? 'active' : ''}">Processing</a>
			<a th:href="@{/admin/orders(status='OUT_FOR_DELIVERY')}"
				class="btn btn-outline-delivery"
				th:classappend="${currentStatus == 'OUT_FOR_DELIVERY' ? 'active' : ''}">
				Out for Delivery </a>
			<a th:href="@{/admin/orders(status='DELIVERED')}"
				class="btn btn-outline-success"
				th:classappend="${currentStatus == 'DELIVERED' ? 'active' : ''}">Delivered</a>
			<a th:href="@{/admin/orders(status='CANCELLED')}"
				class="btn btn-outline-danger"
				th:classappend="${currentStatus == 'CANCELLED' ? 'active' : ''}">Cancelled</a>
			<a th:href="@{/admin/orders(status='REJECTED')}"
				class="btn btn-outline-danger"
				th:classappend="${currentStatus == 'REJECTED' ? 'active' : ''}">Rejected</a>
		</div>

		<form th:action="@{/admin/orders}" method="get"
			class="mb-4 p-3 bg-light rounded shadow-sm">
			<div class="d-flex flex-column flex-md-row gap-2">
				<div class="flex-grow-1">
					<label for="keyword" class="form-label">Search by Order ID
						or Customer Name</label> <input type="text" class="form-control"
						id="keyword" name="keyword" th:value="${keyword}"
						placeholder="Enter search term...">
				</div>
				<div class="d-flex gap-2 align-self-md-end" style="flex-shrink: 0;">
					<button type="submit" class="btn btn-action-view" title="Search">
						<i class="fa-solid fa-search"></i> <span
							class="d-none d-md-inline ms-1">Search</span>
					</button>
					<a th:href="@{/admin/orders}" class="btn btn-custom-secondary"
						title="Clear Search & Filters"> <i class="fa-solid fa-times"></i>
						<span class="d-none d-md-inline ms-1">Clear</span>
					</a>
				</div>
				<input type="hidden" name="status" th:value="${currentStatus}" />
			</div>
		</form>

		<div class="card">
			<div class="card-header">
				<h5 class="mb-0">Orders List</h5>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover align-middle">
						<thead class="table-light">
							<tr>
								<th>Order ID</th>
								<th>Date</th>
								<th>Customer</th>
								<th>Items</th>
								<th>Total</th>
								<th>Payment</th>
								<th>Status</th>
								<th style="width: 250px;">Actions</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order : ${orders}"
								th:data-order-id="${order.id}"
								th:data-order-date="${#temporals.format(order.orderDate, 'MMM dd, yyyy • h:mm a')}"
								th:data-customer-name="${order.shippingFirstName + ' ' + order.shippingLastName}"
								th:data-customer-phone="${order.shippingPhone}"
								th:data-customer-address="${order.shippingAddress}"
								th:data-order-total="${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}"
								th:data-payment-method="${#strings.toUpperCase(order.paymentMethod)}"
								th:data-payment-status="${#strings.replace(order.paymentStatus, '_', ' ')}"
								th:data-order-status="${#strings.replace(order.status, '_', ' ')}"
								th:data-status-class="${
									order.status == 'PENDING_VERIFICATION' ? 'status-pending-verification' : 
									(order.status == 'OUT_FOR_DELIVERY' ? 'status-out-for-delivery' : 
									'status-' + #strings.toLowerCase(order.status))}"
								th:data-notes="${order.notes}"
								th:data-receipt-url="${order.paymentReceiptImageUrl}"
								th:data-transaction-id="${order.transactionId}"
								th:data-items-json="'[' + ${#strings.listJoin(
									order.items.![
										'{' +
										'&quot;name&quot;:&quot;' + #strings.escapeJavaScript(product.name) + '&quot;,' +
										'&quot;quantity&quot;:' + quantity + ',' +
										'&quot;price&quot;:' + pricePerUnit +
										'}'
									],
									','
								)} + ']'">
								<td th:text="'#ORD-' + ${order.id}">#ORD-XXXX</td>
								<td
									th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy HH:mm')}">Date</td>
								<td
									th:text="${order.shippingFirstName + ' ' + order.shippingLastName}">Customer
									Name</td>
								<td class="text-start">
									<ul class="list-unstyled mb-0 small">
										<li th:each="item : ${order.items}"
											th:text="${item.quantity + 'x ' + item.product.name}">
											Item Summary</li>
									</ul>
								</td>
								<td
									th:text="'₱' + ${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}">₱0.00</td>
								<td
									th:text="${#strings.toUpperCase(order.paymentMethod)}">PAYMENT</td>
								<td><span class="status-badge"
									th:text="${
										order.status == 'PENDING' ? 'PENDING (COD)' : 
										(order.status == 'PENDING_VERIFICATION' ? 'PENDING (GCASH)' : 
										(order.status == 'OUT_FOR_DELIVERY' ? 'OUT FOR DELIVERY' : 
										#strings.replace(order.status, '_', ' ')))}"
									th:classappend="${
										order.status == 'PENDING_VERIFICATION' ? 'status-pending-verification' : 
										(order.status == 'OUT_FOR_DELIVERY' ? 'status-out-for-delivery' : 
										'status-' + #strings.toLowerCase(order.status))}">
										Status </span></td>
								
								<td>
									<div class="d-flex gap-1 justify-content-start flex-wrap"> <button
											class="btn btn-sm btn-action-view view-order-btn"
											data-bs-toggle="modal" data-bs-target="#viewOrderModal">View</button>
										
										<button type="button"
											class="btn btn-sm btn-custom-outline"
											th:classappend="${openIssueCounts.get(order.id) != null ? 'btn-outline-danger' : ''}"
											th:if="${#authorization.expression('hasAuthority(''VIEW_ISSUE_REPORTS'')')}"
											data-bs-toggle="modal" data-bs-target="#viewIssuesModal"
											th:data-order-id="${order.id}"
											th:title="${openIssueCounts.get(order.id) != null ? 'View ' + openIssueCounts.get(order.id) + ' Open Issue(s)' : 'View Issues'}">
											<i class="fa-solid fa-flag"></i>
											<span th:if="${openIssueCounts.get(order.id) != null}"
												  class="badge bg-danger rounded-pill"
												  style="font-size: 0.6rem; vertical-align: top; margin-left: -5px;"
												  th:text="${openIssueCounts.get(order.id)}"></span>
										</button>
										<th:block
											th:if="${order.status == 'PENDING' or order.status == 'PENDING_VERIFICATION'}"
											sec:authorize="hasAuthority('EDIT_ORDERS')">
											<form
												th:action="@{/admin/orders/update-status/{id}(id=${order.id})}"
												method="post" class="d-inline"
												th:data-confirm-save-message="'Are you sure you want to ACCEPT Order ' + ${order.id} + '?'">
												
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
												<input type="hidden" name="action" value="accept" />
												<button type="submit" class="btn btn-sm btn-action-success">Accept</button>
											</form>
											<form
												th:action="@{/admin/orders/update-status/{id}(id=${order.id})}"
												method="post" class="d-inline"
												th:data-confirm-message="'Are you sure you want to REJECT Order ' + ${order.id} + '? This will reverse the stock.'">
												
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
												<input type="hidden" name="action" value="reject" />
												<button type="submit" class="btn btn-sm btn-action-delete">Reject</button>
											</form>
										</th:block>
										
										<th:block th:if="${order.status == 'PROCESSING'}"
											sec:authorize="hasAuthority('EDIT_ORDERS')">
											<form
												th:action="@{/admin/orders/update-status/{id}(id=${order.id})}"
												method="post" class="d-inline"
												th:data-confirm-save-message="'Are you sure you want to SHIP Order ' + ${order.id} + '?'">
												
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
												<input type="hidden" name="action" value="ship" />
												<button type="submit" class="btn btn-sm btn-action-delivery">Ship</button>
											</form>
										</th:block>
										
										<th:block
											th:if="${order.status == 'OUT_FOR_DELIVERY'}"
											sec:authorize="hasAuthority('EDIT_ORDERS')">
											<form
												th:if="${#strings.equalsIgnoreCase(order.paymentMethod, 'cod')}"
												th:action="@{/admin/orders/update-status/{id}(id=${order.id})}"
												method="post" class="d-inline"
												th:data-confirm-save-message="'Confirm payment received for COD Order ' + ${order.id} + '?'">
												
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
												<input type="hidden" name="action" value="complete_cod" />
												<button type="submit" class="btn btn-sm btn-action-success">Complete</button>
											</form>
											<form
												th:if="${!#strings.equalsIgnoreCase(order.paymentMethod, 'cod')}"
												th:action="@{/admin/orders/update-status/{id}(id=${order.id})}"
												method="post" class="d-inline"
												th:data-confirm-save-message="'Confirm Order ' + ${order.id} + ' has been delivered?'">
												
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
												<input type="hidden" name="action" value="complete_delivered" />
												<button type="submit" class="btn btn-sm btn-action-success">Complete</button>
											</form>
										</th:block>
									</div>
								</td>
							</tr>
							<tr th:if="${#lists.isEmpty(orders)}">
								<td colspan="8" class="text-center text-muted"
									th:text="${(keyword != null or currentStatus != null) ? 'No orders found matching your criteria.' : 'No orders placed yet.'}">
									No orders placed yet.</td>
							</tr>
						</tbody>
					</table>
				</div>

				<div th:if="${orderPage.totalPages > 0}"
					class="d-flex justify-content-center mt-3">

					<nav aria-label="Order Pagination">
						<ul class="pagination pagination-sm mb-0">

							<li class="page-item"
								th:classappend="${orderPage.first} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/orders(page=${orderPage.number - 1}, size=${size}, keyword=${keyword}, status=${currentStatus})}">Previous</a>
							</li>

							<th:block
								th:each="i : ${#numbers.sequence(0, orderPage.totalPages - 1)}"
								th:if="${orderPage.totalPages <= 7 || i == 0 || i == orderPage.totalPages - 1 || (i >= orderPage.number - 2 && i <= orderPage.number + 2)}">

								<li class="page-item disabled"
									th:if="${orderPage.totalPages > 7 && (i == 0 && orderPage.number > 3 || i == orderPage.totalPages - 1 && orderPage.number < orderPage.totalPages - 4)}">
									<span class="page-link">...</span>
								</li>

								<li class="page-item"
									th:classappend="${i == orderPage.number} ? 'active'"><a
									class="page-link"
									th:href="@{/admin/orders(page=${i}, size=${size}, keyword=${keyword}, status=${currentStatus})}"
									th:text="${i + 1}"></a></li>
							</th:block>

							<li class="page-item"
								th:classappend="${orderPage.last} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/orders(page=${orderPage.number + 1}, size=${size}, keyword=${keyword}, status=${currentStatus})}">Next</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>

		<div th:replace="~{admin/fragments/order-modal :: order-view-modal}"></div>
		<div th:replace="~{admin/fragments/admin-issue-modal :: admin-issue-modal}"></div>

	</div>
	<th:block th:fragment="script">
		<script th:src="@{/js/admin-orders.js}"></script>
	</th:block>
</body>
</html>