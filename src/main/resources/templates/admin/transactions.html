<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{admin/base :: layout(~{::#admin-content-wrapper}, ~{::script}, 'transactions')}">
<head>
<title>Transaction History - MK Admin Portal</title>
</head>
<body>

	<div id="admin-content-wrapper">
		<div
			class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
			<h1 class="mb-3 mb-md-0 section-title">Transaction History</h1>
		</div>

		<div class="row text-center mb-4">
			<div class="col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Total Revenue (Completed)</h5>
						<p class="display-6 fw-bold"
							th:text="'₱' + ${#numbers.formatDecimal(totalRevenue, 1, 'COMMA', 2, 'POINT')}">
							₱0.00</p>
					</div>
				</div>
			</div>
			<div class="col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Total Completed Transactions</h5>
						<p class="display-6 fw-bold" th:text="${totalTransactions}">0</p>
					</div>
				</div>
			</div>
			<div class="col-md-4 mb-3">
				<div class="stats-card card shadow-sm">
					<div class="card-body">
						<h5 class="card-title">Average Order Value</h5>
						<p class="display-6 fw-bold"
							th:text="'₱' + ${#numbers.formatDecimal(avgOrderValue, 1, 'COMMA', 2, 'POINT')}">
							₱0.00</p>
					</div>
				</div>
			</div>
		</div>

		<form th:action="@{/admin/transactions}" method="get"
			class="mb-4 p-3 bg-light rounded shadow-sm">
			<div class="d-flex flex-column flex-md-row gap-2">
				<div class="flex-grow-1">
					<div class="row g-2">
						<div class="col-md-6">
							<label for="keyword" class="form-label">Search by Order
								ID or Customer Name</label> <input type="text" class="form-control"
								id="keyword" name="keyword" th:value="${keyword}"
								placeholder="Enter search term...">
						</div>
						<div class="col-md-3">
							<label for="startDate" class="form-label">From</label> <input
								type="date" class="form-control" id="startDate" name="startDate"
								th:value="${startDate}">
						</div>
						<div class="col-md-3">
							<label for="endDate" class="form-label">To</label> <input
								type="date" class="form-control" id="endDate" name="endDate"
								th:value="${endDate}">
						</div>
					</div>
				</div>
				<div class="d-flex gap-2 align-self-md-end" style="flex-shrink: 0;">
					<button type="submit" class="btn btn-action-view" title="Search">
						<i class="fa-solid fa-search"></i> <span
							class="d-none d-md-inline ms-1">Search</span>
					</button>
					<a th:href="@{/admin/transactions}"
						class="btn btn-custom-secondary" title="Clear Search"> <i
						class="fa-solid fa-times"></i> <span
						class="d-none d-md-inline ms-1">Clear</span>
					</a>
					<div class="btn-group">
						<button type="button"
							class="btn btn-action-success dropdown-toggle"
							data-bs-toggle="dropdown" aria-expanded="false">
							<i class="fa-solid fa-download me-1"></i> Export
						</button>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><button class="dropdown-item" type="submit"
									formaction="/admin/reports/financial" formmethod="get">
									<i class="fa-solid fa-file-excel me-2"></i>Export as Excel
								</button></li>
							<li><button class="dropdown-item" type="submit"
									formaction="/admin/reports/financial/pdf" formmethod="get">
									<i class="fa-solid fa-file-pdf me-2"></i>Export as PDF
								</button></li>
						</ul>
					</div>
				</div>
			</div>
		</form>

		<div class="card mb-4">
			<div class="card-header">
				<h5 class="mb-0">All Transactions</h5>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover align-middle text-center">
						<thead class="table-light">
							<tr>
								<th>Order ID</th>
								<th>Date</th>
								<th>Customer</th>
								<th>Amount</th>
								<th>Payment Method</th>
								<th>Status</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order : ${transactions}"
								th:data-order-id="${order.id}"
								th:data-order-date="${#temporals.format(order.orderDate, 'MMM dd, yyyy • h:mm a')}"
								th:data-customer-name="${order.shippingFirstName + ' ' + order.shippingLastName}"
								th:data-customer-phone="${order.shippingPhone}"
								th:data-customer-address="${order.shippingAddress}"
								th:data-order-total="${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}"
								th:data-payment-method="${#strings.toUpperCase(order.paymentMethod)}"
								th:data-payment-status="${#strings.replace(order.paymentStatus, '_', ' ')}"
								th:data-order-status="${#strings.replace(order.status, '_', ' ')}"
								th:data-status-class="${
									order.status == 'PENDING_VERIFICATION' ? 'status-pending-verification' : 
									(order.status == 'OUT_FOR_DELIVERY' ? 'status-out-for-delivery' : 
									'status-' + #strings.toLowerCase(order.status))}"
								th:data-notes="${order.notes}"
								th:data-receipt-url="${order.paymentReceiptImageUrl}"
								th:data-transaction-id="${order.transactionId}"
								th:data-items-json="'[' + ${#strings.listJoin(
									order.items.![
										'{' +
										'&quot;name&quot;:&quot;' + #strings.escapeJavaScript(product.name) + '&quot;,' +
										'&quot;quantity&quot;:' + quantity + ',' +
										'&quot;price&quot;:' + pricePerUnit +
										'}'
									],
									','
								)} + ']'">
								<td th:text="'#ORD-' + ${order.id}">#ORD-XXXX</td>
								<td
									th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy HH:mm')}">Date</td>
								<td
									th:text="${order.shippingFirstName + ' ' + order.shippingLastName}">Customer
									Name</td>
								<td
									th:text="'₱' + ${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}">
									₱0.00</td>
								<td
									th:text="${order.paymentMethod != null ? #strings.toUpperCase(order.paymentMethod) : 'N/A'}">GCash</td>
								<td><span class="status-badge" th:text="${#strings.replace(order.status, '_', ' ')}"
									th:classappend="'status-' + ${#strings.toLowerCase(order.status)}">
										Status </span></td>
								<td class="d-flex justify-content-center gap-1"> <button class="btn btn-sm btn-action-view view-order-btn"
										data-bs-toggle="modal" data-bs-target="#viewOrderModal">View</button>
									<a th:href="@{/admin/reports/invoice/{id}(id=${order.id})}"
										class="btn btn-sm btn-custom-outline" target="_blank"
										title="Print Invoice/Receipt"
										sec:authorize="hasAuthority('VIEW_ORDERS')">
										<i class="fa-solid fa-print"></i>
									</a>
									</td>
							</tr>
							<tr th:if="${#lists.isEmpty(transactions)}">
								<td colspan="7" class="text-center text-muted"
									th:text="${(keyword != null or startDate != null or endDate != null) ? 'No transactions found matching your criteria.' : 'No transactions found.'}">
									No transactions found.</td>
							</tr>
						</tbody>
					</table>
				</div>

				<div th:if="${transactionPage.totalPages > 0}"
					class="d-flex justify-content-center mt-3">
					
					<nav aria-label="Transaction Pagination">
						<ul class="pagination pagination-sm mb-0">
							<li class="page-item"
								th:classappend="${transactionPage.first} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/transactions(page=${transactionPage.number - 1}, size=${size}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate})}">Previous</a>
							</li>
							<th:block
								th:each="i : ${#numbers.sequence(0, transactionPage.totalPages - 1)}"
								th:if="${transactionPage.totalPages <= 7 || i == 0 || i == transactionPage.totalPages - 1 || (i >= transactionPage.number - 2 && i <= transactionPage.number + 2)}">
								<li class="page-item disabled"
									th:if="${transactionPage.totalPages > 7 && (i == 0 && transactionPage.number > 3 || i == transactionPage.totalPages - 1 && transactionPage.number < transactionPage.totalPages - 4)}">
									<span class="page-link">...</span>
								</li>
								<li class="page-item"
									th:classappend="${i == transactionPage.number} ? 'active'">
									<a class="page-link"
									th:href="@{/admin/transactions(page=${i}, size=${size}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate})}"
									th:text="${i + 1}"></a>
								</li>
							</th:block>
							<li class="page-item"
								th:classappend="${transactionPage.last} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/transactions(page=${transactionPage.number + 1}, size=${size}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate})}">Next</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
		
		<div th:replace="~{admin/fragments/order-modal :: order-view-modal}"></div>
		
	</div>
	
	<th:block th:fragment="script">
		<script th:src="@{/js/admin-orders.js}"></script>
	</th:block>
	
</body>
</html>