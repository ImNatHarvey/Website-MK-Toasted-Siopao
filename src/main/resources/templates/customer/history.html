<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{customer/base :: layout(~{::main}, ~{::script})}">
<head>
<title>Order History - MK Toasted Siopao</title>
</head>
<body>
	<main>
		<div class="container mt-4" th:data-re-open-issue-modal="${reOpenIssueModal}">
			<div class="history-header">
				<div class="row align-items-center">
					<div class="col-md-8">
						<h2 class="section-title mb-1">Order History</h2>
						<p class="text-muted mb-0">View your past orders and track
							current ones</p>
					</div>
					<div class="col-md-4 text-end">
						<a th:href="@{/u/menu}" class="btn btn-custom">Place New Order</a>
					</div>
				</div>
			</div>

			<div class="d-flex justify-content-center flex-wrap gap-2 my-4">
				<a th:href="@{/u/history}" class="btn btn-outline-primary"
					th:classappend="${currentStatus == null ? 'active' : ''}">All
					Orders</a> <a th:href="@{/u/history(status='PENDING_VERIFICATION')}"
					class="btn btn-outline-primary"
					th:classappend="${currentStatus == 'PENDING_VERIFICATION' ? 'active' : ''}">
					Pending (GCASH) </a> <a th:href="@{/u/history(status='PENDING')}"
					class="btn btn-outline-warning"
					th:classappend="${currentStatus == 'PENDING' ? 'active' : ''}">Pending
					(COD)</a> <a th:href="@{/u/history(status='PROCESSING')}"
					class="btn btn-outline-info"
					th:classappend="${currentStatus == 'PROCESSING' ? 'active' : ''}">Processing</a>

				<a th:href="@{/u/history(status='OUT_FOR_DELIVERY')}"
					class="btn btn-outline-delivery"
					th:classappend="${currentStatus == 'OUT_FOR_DELIVERY' ? 'active' : ''}">
					Out for Delivery </a> <a th:href="@{/u/history(status='DELIVERED')}"
					class="btn btn-outline-success"
					th:classappend="${currentStatus == 'DELIVERED' ? 'active' : ''}">Delivered</a>
				<a th:href="@{/u/history(status='CANCELLED')}"
					class="btn btn-outline-danger"
					th:classappend="${currentStatus == 'CANCELLED' ? 'active' : ''}">Cancelled</a>
				<a th:href="@{/u/history(status='REJECTED')}"
					class="btn btn-outline-danger"
					th:classappend="${currentStatus == 'REJECTED' ? 'active' : ''}">Rejected</a>
			</div>

			<div th:if="${orderPage.empty}"
				class="alert alert-warning text-center" role="alert">You have
				no orders matching this status.</div>

			<div id="ordersList" th:unless="${orderPage.empty}">

				<div class="card shadow-sm mb-3"
					th:each="order : ${orderPage.content}">
					<div
						class="card-header d-flex justify-content-between align-items-center flex-wrap">
						<div>
							<h5 class="mb-1" style="font-size: 1.1rem; font-weight: bold;">
								Order <span th:text="'#ORD-' + ${order.id}">#ORD-XXXX</span>
							</h5>
							<p class="text-muted small mb-0"
								th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy • h:mm a')}">
								Date</p>
						</div>

						<div class="d-flex align-items-center gap-2">
							<span class="status-badge fs-6"
								th:text="${
									order.status == 'PENDING' ? 'PENDING (COD)' : 
									(order.status == 'PENDING_VERIFICATION' ? 'PENDING (GCASH)' : 
									(order.status == 'OUT_FOR_DELIVERY' ? 'OUT FOR DELIVERY' : 
									#strings.replace(order.status, '_', ' ')))}"
								th:classappend="${
									order.status == 'PENDING_VERIFICATION' ? 'status-pending-verification' : 
									(order.status == 'OUT_FOR_DELIVERY' ? 'status-out-for-delivery' : 
									'status-' + #strings.toLowerCase(order.status))}">
								Status </span>

							<a th:if="${order.status != 'PENDING' and order.status != 'PENDING_VERIFICATION'}"
							   th:href="@{/u/history/download/invoice/{id}(id=${order.id})}"
							   class="btn btn-sm btn-action-view" target="_blank"
							   title="Download Invoice">
								<i class="fa-solid fa-file-invoice me-1"></i> Invoice
							</a>
							
							<a th:if="${order.status == 'DELIVERED'}"
							   th:href="@{/u/history/download/receipt/{id}(id=${order.id})}"
							   class="btn btn-sm btn-action-view" target="_blank"
							   title="Download Receipt">
								<i class="fa-solid fa-receipt me-1"></i> Receipt
							</a>
							
							<button th:if="${order.status == 'DELIVERED' AND #lists.isEmpty(order.issueReports)}"
									type="button" class="btn btn-sm btn-action-edit"
									data-bs-toggle="modal" data-bs-target="#reportIssueModal"
									th:data-order-id="${order.id}">
								<i class="fa-solid fa-flag me-1"></i> Report an Issue
							</button>
							
							<button th:if="${order.status == 'DELIVERED' AND !#lists.isEmpty(order.issueReports)}"
									type="button" class="btn btn-sm btn-outline-info view-issue-report-btn"
									data-bs-toggle="modal" data-bs-target="#viewIssueReportModal"
									th:data-order-id="${order.id}">
								<i class="fa-solid fa-eye me-1"></i> View Issue Report
							</button>
							<form
								th:if="${order.status == 'PENDING' or order.status == 'PENDING_VERIFICATION'}"
								th:action="@{/u/history/cancel/{id}(id=${order.id})}"
								method="post"
								th:data-confirm-message="'Are you sure you want to cancel order #ORD-' + ${order.id} + '?'">
								
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
								
								<button type="submit" class="btn btn-sm btn-outline-danger">
									<i class="fa-solid fa-times me-1"></i> Cancel Order
								</button>
							</form>
							</div>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-8">
								<h6 class="mb-2">Items:</h6>
								<ul class="list-unstyled">
									<li th:each="item : ${order.items}"
										th:text="${item.quantity + 'x ' + item.product.name}">2x
										Product Name</li>
								</ul>
								<div
									th:if="${order.notes != null and !#strings.isEmpty(order.notes)}">
									<h6 class="mb-2 mt-3">Notes:</h6>
									<p class="small text-muted" th:text="${order.notes}"></p>
								</div>
							</div>
							<div class="col-md-4 text-md-end">
								<h6 class="mb-2">Total Amount</h6>
								<h4 class="text-primary fw-bold"
									th:text="'₱' + ${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}">
									₱0.00</h4>
								<h6 class="mb-2 mt-3">Payment</h6>
								<p class="mb-0"
									th:text="${#strings.toUpperCase(order.paymentMethod)}">GCASH</p>
							</div>
						</div>
						
						</div>
				</div>

			</div>

			<div th:if="${orderPage.totalPages > 0}"
				class="d-flex justify-content-center mt-4 mb-5">
				<nav aria-label="Order history pagination">
					<ul class="pagination pagination-sm mb-0">
						<li class="page-item"
							th:classappend="${orderPage.first} ? 'disabled'"><a
							class="page-link"
							th:href="@{/u/history(page=${orderPage.number - 1}, size=${size}, status=${currentStatus})}">Previous</a>
						</li>

						<th:block
							th:each="i : ${#numbers.sequence(0, orderPage.totalPages - 1)}"
							th:if="${orderPage.totalPages <= 7 || i == 0 || i == orderPage.totalPages - 1 || (i >= orderPage.number - 2 && i <= orderPage.number + 2)}">

							<li class="page-item disabled"
								th:if="${orderPage.totalPages > 7 && (i == 0 && orderPage.number > 3 || i == orderPage.totalPages - 1 && orderPage.number < orderPage.totalPages - 4)}">
								<span class="page-link">...</span>
							</li>

							<li class="page-item"
								th:classappend="${i == orderPage.number} ? 'active'"><a
								class="page-link"
								th:href="@{/u/history(page=${i}, size=${size}, status=${currentStatus})}"
								th:text="${i + 1}"></a></li>
						</th:block>

						<li class="page-item"
							th:classappend="${orderPage.last} ? 'disabled'"><a
							class="page-link"
							th:href="@{/u/history(page=${orderPage.number + 1}, size=${size}, status=${currentStatus})}">Next</a>
						</li>
					</ul>
				</nav>
			</div>
		</div>
		
		<th:block th:fragment="script">
			<script th:inline="javascript">
				document.addEventListener('DOMContentLoaded', function() {
					const mainContainer = document.querySelector('main .container');
					const reOpenOrderId = /*[[${reOpenIssueModal}]]*/ null;
					
					if (reOpenOrderId) {
						console.log("Re-opening issue modal for order: " + reOpenOrderId);
						const reportIssueModalEl = document.getElementById('reportIssueModal');
						if (reportIssueModalEl) {
							// Set a flag for the modal's own JS to pick up
							reportIssueModalEl.dataset.isValidationReopen = 'true';
							
							const modal = new bootstrap.Modal(reportIssueModalEl);
							const modalLabel = reportIssueModalEl.querySelector('#reportIssueModalLabel');
							modalLabel.textContent = 'Report an Issue for Order #ORD-' + reOpenOrderId;
							
							modal.show();
						}
					}
				});
			</script>
			
			<script th:src="@{/js/customer-history.js}"></script>
			</th:block>
		</main>
</body>
</html>