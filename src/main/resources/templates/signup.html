<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base :: layout(~{::main}, ~{::script})}">
<head>
<meta charset="UTF-8">
<title>Sign Up - MK Toasted Siopao</title>
</head>
<body>
	<main
		class="container d-flex flex-column flex-grow-1 justify-content-center">
		<section class="auth-section">
			<div class="row justify-content-center">
				<div class="col-12 col-lg-10 col-xl-8">
					<div class="card shadow-sm p-4 auth-card">
						<h2 class="text-center mb-3 section-title">Create Your
							Account</h2>

						<div th:if="${checkoutMessage}"
							class="alert alert-info d-flex align-items-center" role="alert">
							<i class="fa-solid fa-circle-info fa-lg me-2"></i>
							<div>
								<strong class="d-block" th:text="${checkoutMessage}"></strong>
								Your delivery details have been pre-filled.
							</div>
						</div>
						<div th:if="${errorMessage}"
							class="alert alert-danger alert-dismissible fade show"
							role="alert">
							<span th:text="${errorMessage}"></span>
							<button type="button" class="btn-close" data-bs-dismiss="alert"
								aria-label="Close"></button>
						</div>

						<form id="signupForm" method="post" th:action="@{/signup}"
							th:object="${customerSignUpDto}">
							
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							
							<input type="hidden" name="source" th:value="${param.source}">
							<input type="hidden" th:field="*{cartDataJson}" id="cartDataJsonInput">

							<div class="row">

								<div class="col-lg-6">
									<h5 class="mb-3">Personal Details</h5>

									<div class="row mb-3">
										<div class="col">
											<label for="firstName" class="form-label">First Name</label>
											<input type="text" class="form-control"
												th:field="*{firstName}" th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('firstName')}"
												th:errors="*{firstName}">First Name Error</div>
										</div>
										<div class="col">
											<label for="lastName" class="form-label">Last Name</label> <input
												type="text" class="form-control" th:field="*{lastName}"
												th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('lastName')}"
												th:errors="*{lastName}">Last Name Error</div>
										</div>
									</div>

									<div class="mb-3">
										<label for="email" class="form-label">Email</label> <input
											type="email" class="form-control" th:field="*{email}"
											th:errorclass="is-invalid" placeholder="you@example.com">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('email')}" th:errors="*{email}">Email
											Error</div>
									</div>
									<div class="mb-3">
										<label for="phone" class="form-label">Phone Number</label> <input
											type="tel" class="form-control" th:field="*{phone}"
											th:errorclass="is-invalid">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}">Phone
											Error</div>
									</div>
								</div>
								<div class="col-lg-6 border-start-lg ps-lg-4">
									<h5 class="mb-3">Location Details</h5>
									<div class="row g-2 mb-3">
										<div class="col">
											<label for="houseNo" class="form-label visually-hidden">House
												No.</label> <input type="text" class="form-control"
												placeholder="House No." th:field="*{houseNo}"
												th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('houseNo')}"
												th:errors="*{houseNo}">House No. Error</div>
										</div>
										<div class="col">
											<label for="lotNo" class="form-label visually-hidden">Lot
												No.</label> <input type="text" class="form-control"
												placeholder="Lot No." th:field="*{lotNo}"
												th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('lotNo')}" th:errors="*{lotNo}">Lot
												No. Error</div>
										</div>
										<div class="col">
											<label for="blockNo" class="form-label visually-hidden">Block
												No.</label> <input type="text" class="form-control"
												placeholder="Block No." th:field="*{blockNo}"
												th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('blockNo')}"
												th:errors="*{blockNo}">Block No. Error</div>
										</div>
									</div>
									<div class="mb-3">
										<label for="street" class="form-label visually-hidden">Street</label>
										<input type="text" class="form-control"
											placeholder="Street / Subdivision" th:field="*{street}"
											th:errorclass="is-invalid">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('street')}" th:errors="*{street}">Street
											Error</div>
									</div>
									<div class="row g-2 mb-3">
										<div class="col">
											<label for="barangay" class="form-label visually-hidden">Barangay</label>
											<input type="text" class="form-control"
												placeholder="Barangay" th:field="*{barangay}"
												th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('barangay')}"
												th:errors="*{barangay}">Barangay Error</div>
										</div>
										<div class="col">
											<label for="municipality" class="form-label visually-hidden">Municipality</label>
											<input type="text" class="form-control"
												placeholder="Municipality" th:field="*{municipality}"
												th:errorclass="is-invalid">
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('municipality')}"
												th:errors="*{municipality}">Municipality Error</div>
										</div>
									</div>
									<div class="mb-3">
										<label for="province" class="form-label visually-hidden">Province</label>
										<input type="text" class="form-control" placeholder="Province"
											th:field="*{province}" th:errorclass="is-invalid">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('province')}"
											th:errors="*{province}">Province Error</div>
									</div>
								</div>
							</div>
							<div class="row mt-3">
								<div class="col-12">
									<h5 class="mb-3 text-center">Account Security</h5>
								</div>
								<div class="col-lg-6">
									<div class="mb-3">
										<label for="username" class="form-label">Username</label> <input
											type="text" class="form-control" th:field="*{username}"
											th:errorclass="is-invalid"
											placeholder="Choose a unique username">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('username')}"
											th:errors="*{username}">Username Error</div>
									</div>
								</div>
								<div class="col-lg-6"></div>

								<div class="col-lg-6">
									<div class="mb-3">
										<label for="password" class="form-label">Password</label> <input
											type="password" class="form-control" th:field="*{password}"
											th:errorclass="is-invalid"
											placeholder="At least 8 characters">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('password')}"
											th:errors="*{password}">Password Error</div>
									</div>
								</div>
								<div class="col-lg-6">
									<div class="mb-3">
										<label for="confirmPassword" class="form-label">Confirm
											Password</label> <input type="password" class="form-control"
											th:field="*{confirmPassword}" th:errorclass="is-invalid"
											placeholder="Re-type your password">
										<div class="invalid-feedback"
											th:if="${#fields.hasErrors('confirmPassword')}"
											th:errors="*{confirmPassword}">Confirm Password Error</div>
									</div>
								</div>
							</div>
							<div class="row justify-content-center mt-2">
								<div class="col-12 col-md-10 col-lg-8">
									<div class="d-flex justify-content-center">
										<div class="mb-3 form-check text-center"
											th:classappend="${#fields.hasErrors('terms')} ? 'is-invalid' : ''">
											<input type="checkbox" class="form-check-input"
												th:field="*{terms}" th:errorclass="is-invalid"> <label
												class="form-check-label" for="terms"> I agree to the
												<a href="#" data-bs-toggle="modal"
												data-bs-target="#termsOfServiceModal">Terms of Service</a>
												and <a href="#" data-bs-toggle="modal"
												data-bs-target="#privacyPolicyModal">Privacy Policy</a>
											</label>
											<div class="invalid-feedback"
												th:if="${#fields.hasErrors('terms')}" th:errors="*{terms}">Terms
												Error</div>
										</div>
									</div>
									<div class="d-grid">
										<button type="submit" class="btn btn-custom">Create
											Account</button>
									</div>
								</div>
							</div>
						</form>

						<p class="text-center mt-3">
							Already have an account? <a th:href="@{/login}">Log in here</a>
						</p>
					</div>
				</div>
			</div>
		</section>

		<th:block th:fragment="script">
			<script th:inline="javascript">
				document
						.addEventListener(
								'DOMContentLoaded',
								function() {
									const params = new URLSearchParams(
											window.location.search);
									if (params.get('source') === 'checkout') {
										console
												.log("Signup page loaded from checkout.");
										const guestDataString = sessionStorage
												.getItem('guestCheckoutData');
												
										// --- MODIFIED ---
										const cartDataString = sessionStorage
												.getItem('mkSiopaoCart');
										const cartInput = document.getElementById('cartDataJsonInput');
										
										if (cartInput && cartDataString) {
											console.log("Found guest cart data. Attaching to form.");
											cartInput.value = cartDataString;
										}
										// --- END MODIFIED ---
												
										if (guestDataString) {
											console
													.log("Found guest checkout data. Pre-filling form.");
											try {
												const guestData = JSON
														.parse(guestDataString);
	
												// Map of guestData keys to form field IDs
												const fieldMap = {
													firstName : 'firstName',
													lastName : 'lastName',
													email : 'email',
													phone : 'phone',
													houseNo : 'houseNo',
													lotNo : 'lotNo',
													blockNo : 'blockNo',
													street : 'street',
													barangay : 'barangay',
													municipality : 'municipality',
													province : 'province'
												};
	
												for ( const key in fieldMap) {
													const field = document
															.getElementById(fieldMap[key]);
													if (field && guestData[key]) {
														field.value = guestData[key];
													}
												}
	
												// Clean up the address data, but NOT the cart data
												sessionStorage
														.removeItem('guestCheckoutData');
	
												// Focus the first empty field (username)
												const usernameField = document
														.getElementById('username');
												if (usernameField) {
													usernameField.focus();
												}
	
											} catch (e) {
												console
														.error(
																"Failed to parse guest checkout data:",
																e);
												sessionStorage
														.removeItem('guestCheckoutData');
											}
										} else {
											console
													.log("Loaded from checkout, but no guest data found in session storage.");
										}
										
										// --- ADDED ---
										// Clear the cart from session storage AFTER submitting the form
										const signupForm = document.getElementById('signupForm');
										if (signupForm) {
											signupForm.addEventListener('submit', function() {
												console.log("Signup submitted, clearing guest cart from session storage.");
												sessionStorage.removeItem('mkSiopaoCart');
											});
										}
										// --- END ADDED ---
									}
								});
			</script>
		</th:block>
	</main>
</body>
</html>